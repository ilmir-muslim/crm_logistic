{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0">
                    {% if order.tracking_number %}
                        {{ order.tracking_number }}
                    {% else %}
                        Заявка на забор #{{ order.id }}
                    {% endif %}
                    - {{ order.client_name }}
                </h4>
                <small class="text-muted">Создано: {{ order.created_at|date:"d.m.Y H:i" }}</small>
            </div>
            <div class="text-end">
                <span class="badge bg-{% if order.status == 'new' %}secondary{% elif order.status == 'confirmed' %}warning{% elif order.status == 'picked_up' %}success{% else %}danger{% endif %} fs-6">
                    {{ order.get_status_display }}
                </span>
                {% if order.qr_code %}
                <a href="{{ order.qr_code.url }}" class="btn btn-sm btn-outline-primary ms-2" download>
                    <i class="bi bi-qr-code"></i> QR-код
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-7">
                <h5 class="border-bottom pb-2 mb-3">Основная информация</h5>
                <table class="table table-bordered">
                    <tr>
                        <th style="width: 40%">Дата забора:</th>
                        <td>{{ order.pickup_date|date:"d.m.Y" }}</td>
                    </tr>
                    <tr>
                        <th>Время забора:</th>
                        <td>{{ order.pickup_time_range }}</td>
                    </tr>
                    <tr>
                        <th>Клиент:</th>
                        <td><strong>{{ order.client_name }}</strong></td>
                    </tr>
                    <tr>
                        <th>Телефон:</th>
                        <td>{{ order.client_phone|default:"Не указан" }}</td>
                    </tr>
                    <tr>
                        <th>Email:</th>
                        <td>{{ order.client_email|default:"Не указан" }}</td>
                    </tr>
                    <tr>
                        <th>Адрес забора:</th>
                        <td>{{ order.pickup_address }}</td>
                    </tr>
                    <tr>
                        <th>Контактное лицо для выдачи:</th>
                        <td>{{ order.contact_person|default:"Не указано" }}</td>
                    </tr>
                </table>
                
                <h5 class="border-bottom pb-2 mb-3 mt-4">Характеристики груза</h5>
                <table class="table table-bordered">
                    <tr>
                        <th style="width: 40%">Количество мест:</th>
                        <td>{{ order.quantity }}</td>
                    </tr>
                    <tr>
                        <th>Вес:</th>
                        <td>{{ order.weight|default:"Не указан" }} кг</td>
                    </tr>
                    <tr>
                        <th>Объем:</th>
                        <td>{{ order.volume|default:"Не указан" }} м³</td>
                    </tr>
                    <tr>
                        <th>Описание груза:</th>
                        <td>{{ order.cargo_description|default:"Нет описания"|linebreaks }}</td>
                    </tr>
                    <tr>
                        <th>Особые требования:</th>
                        <td>{{ order.special_requirements|default:"Нет"|linebreaks }}</td>
                    </tr>
                </table>
            </div>
            
            <div class="col-md-5">
                <!-- QR-код -->
                {% if order.qr_code %}
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">QR-код заявки на забор</h6>
                    </div>
                    <div class="card-body text-center">
                        <img src="{{ order.qr_code.url }}" 
                             alt="QR-код заявки {{ order.tracking_number }}" 
                             class="img-fluid mb-3"
                             style="max-width: 250px;">
                        <p class="text-muted small">
                            Содержит основную информацию о заявке
                        </p>
                        <div class="d-grid gap-2">
                            <a href="{{ order.qr_code.url }}" 
                               class="btn btn-outline-primary" 
                               download="QR_{{ order.tracking_number }}.png">
                                <i class="bi bi-download"></i> Скачать QR-код
                            </a>
                            
                            <!-- Добавлена кнопка PDF -->
                            <a href="{% url 'pickup_order_pdf' order.pk %}" 
                               class="btn btn-danger">
                                <i class="bi bi-file-pdf"></i> Скачать заявку (PDF)
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Информация о статусе и операторе -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Информация о заявке</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr>
                                <th>Номер накладной:</th>
                                <td>{{ order.invoice_number|default:"Не указан" }}</td>
                            </tr>
                            <tr>
                                <th>Ответственный оператор:</th>
                                <td>
                                    {% if order.operator %}
                                        {{ order.operator.get_full_name|default:order.operator.username }}
                                    {% else %}
                                        <span class="text-danger">Не назначен</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Оператор приемки:</th>
                                <td>
                                    {% if order.receiving_operator %}
                                        {{ order.receiving_operator.get_full_name|default:order.receiving_operator.username }}
                                    {% else %}
                                        <span class="text-muted">Не назначен</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Склад приемки:</th>
                                <td>
                                    {% if order.receiving_warehouse %}
                                        {{ order.receiving_warehouse.name }} ({{ order.receiving_warehouse.city.name }})
                                    {% else %}
                                        <span class="text-muted">Не указан</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Обновлено:</th>
                                <td>{{ order.updated_at|date:"d.m.Y H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Блок связанной доставки -->
                {% if order.delivery_order %}
                <div class="alert alert-success">
                    <h6><i class="bi bi-link-45deg"></i> Связанная заявка на доставку</h6>
                    <p>
                        На основе этой заявки создана 
                        <a href="{% url 'delivery_order_detail' order.delivery_order.pk %}" class="alert-link">
                            заявка на доставку #{{ order.delivery_order.id }}
                        </a>
                    </p>
                    <div class="mt-2">
                        <strong>Статус доставки:</strong>
                        <span class="badge bg-{% if order.status == 'ready' %}info{% elif order.status == 'payment' %}warning{% else %}secondary{% endif %} fs-6">
                            {{ order.get_status_display }}
                        </span>
                    </div>
                </div>
                {% elif order.is_convertible_to_delivery %}
                <div class="alert alert-info">
                    <h6><i class="bi bi-lightning-charge"></i> Преобразование в доставку</h6>
                    <p>
                        Эта заявка готова к преобразованию в заявку на доставку.
                        После преобразования будет автоматически создана новая заявка на доставку.
                    </p>
                    <a href="{% url 'convert_to_delivery' order.pk %}" class="btn btn-success w-100">
                        <i class="bi bi-arrow-right-circle"></i> Создать доставку
                    </a>
                </div>
                {% endif %}
                
                <!-- Внутренние заметки -->
                {% if order.notes %}
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Внутренние заметки</h6>
                    </div>
                    <div class="card-body">
                        {{ order.notes|linebreaks }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex justify-content-between">
            <div>
                <a href="{% url 'pickup_order_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Назад к списку
                </a>
            </div>
            <div>
                <a href="{% url 'pickup_order_update' order.pk %}" class="btn btn-primary me-2">
                    <i class="bi bi-pencil"></i> Редактировать
                </a>
                <a href="{% url 'admin:pickup_pickuporder_change' order.pk %}" 
                   class="btn btn-outline-dark">
                    <i class="bi bi-gear"></i> В админку
                </a>
                <button onclick="window.print()" class="btn btn-outline-info ms-2">
                    <i class="bi bi-printer"></i> Печать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}