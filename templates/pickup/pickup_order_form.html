{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h4 class="mb-0">
            {% if object %}
                Редактирование заявки на забор #{{ object.id }}
            {% else %}
                Создание новой заявки на забор
            {% endif %}
        </h4>
    </div>
    <div class="card-body">
        <form method="post" novalidate id="pickupOrderForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                <p>{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <!-- Скрытые поля для склада приемки -->
            {{ form.receiving_warehouse }}
            
            <div class="row">
                <!-- Левая колонка -->
                <div class="col-md-6">
                    <h5 class="border-bottom pb-2 mb-3">Клиент и адрес забора</h5>
                    
                    <!-- Дата забора -->
                    <div class="mb-3">
                        <label for="id_pickup_date" class="form-label">Дата забора *</label>
                        <input type="date" 
                               name="pickup_date" 
                               id="id_pickup_date" 
                               class="form-control {% if form.pickup_date.errors %}is-invalid{% endif %}"
                               value="{% if form.pickup_date.value %}{{ form.pickup_date.value|date:'Y-m-d' }}{% elif object.pickup_date %}{{ object.pickup_date|date:'Y-m-d' }}{% endif %}"
                               min="{{ today|date:'Y-m-d' }}"
                               required>
                        {% if form.pickup_date.errors %}
                        <div class="invalid-feedback">
                            {{ form.pickup_date.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Время забора -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_pickup_time_from" class="form-label">Время забора от</label>
                            <input type="time" 
                                   name="pickup_time_from" 
                                   id="id_pickup_time_from" 
                                   class="form-control {% if form.pickup_time_from.errors %}is-invalid{% endif %}"
                                   value="{% if form.pickup_time_from.value %}{{ form.pickup_time_from.value|time:'H:i' }}{% elif object.pickup_time_from %}{{ object.pickup_time_from|time:'H:i' }}{% endif %}">
                            {% if form.pickup_time_from.errors %}
                            <div class="invalid-feedback">
                                {{ form.pickup_time_from.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Начало интервала</small>
                        </div>
                        <div class="col-md-6">
                            <label for="id_pickup_time_to" class="form-label">Время забора до</label>
                            <input type="time" 
                                   name="pickup_time_to" 
                                   id="id_pickup_time_to" 
                                   class="form-control {% if form.pickup_time_to.errors %}is-invalid{% endif %}"
                                   value="{% if form.pickup_time_to.value %}{{ form.pickup_time_to.value|time:'H:i' }}{% elif object.pickup_time_to %}{{ object.pickup_time_to|time:'H:i' }}{% endif %}">
                            {% if form.pickup_time_to.errors %}
                            <div class="invalid-feedback">
                                {{ form.pickup_time_to.errors.0 }}
                            </div>
                            {% endif %}
                            <small class="form-text text-muted">Конец интервала</small>
                        </div>
                    </div>
                    
                    <!-- Адрес забора - кликабельное поле -->
                    <div class="mb-3">
                        <label for="{{ form.pickup_address.id_for_label }}" class="form-label">Адрес забора *</label>
                        {{ form.pickup_address }}
                        {% if form.pickup_address.errors %}
                        <div class="invalid-feedback">
                            {{ form.pickup_address.errors.0 }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">Нажмите на поле для выбора адреса забора из списка складов</small>
                    </div>
                    
                    <!-- Контактное лицо -->
                    <div class="mb-3">
                        <label for="{{ form.contact_person.id_for_label }}" class="form-label">Контактное лицо для выдачи груза *</label>
                        {{ form.contact_person }}
                        <small class="form-text text-muted">ФИО лица, которое будет выдавать груз</small>
                        {% if form.contact_person.errors %}
                        <div class="invalid-feedback">
                            {{ form.contact_person.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Отправитель -->
                    <div class="mb-3">
                        <label for="{{ form.sender.id_for_label }}" class="form-label">Отправитель</label>
                        <div class="input-group">
                            {{ form.sender }}
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="openCounterpartyModal('sender')">
                                <i class="bi bi-plus"></i> Создать
                            </button>
                        </div>
                        <small class="form-text text-muted">Контрагент, который отправляет груз (необязательно)</small>
                        {% if form.sender.errors %}
                        <div class="invalid-feedback">
                            {{ form.sender.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Получатель -->
                    <div class="mb-3">
                        <label for="{{ form.recipient.id_for_label }}" class="form-label">Получатель</label>
                        <div class="input-group">
                            {{ form.recipient }}
                            <button type="button" class="btn btn-outline-secondary" 
                                    onclick="openCounterpartyModal('recipient')">
                                <i class="bi bi-plus"></i> Создать
                            </button>
                        </div>
                        <small class="form-text text-muted">Контрагент, который получает груз (необязательно)</small>
                        {% if form.recipient.errors %}
                        <div class="invalid-feedback">
                            {{ form.recipient.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Правая колонка -->
                <div class="col-md-6">
                    <h5 class="border-bottom pb-2 mb-3">Характеристики груза</h5>
                    
                    <!-- Количество, вес, объем -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="{{ form.quantity.id_for_label }}" class="form-label">Количество мест *</label>
                            {{ form.quantity }}
                            {% if form.quantity.errors %}
                            <div class="invalid-feedback">
                                {{ form.quantity.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.weight.id_for_label }}" class="form-label">Вес (кг)</label>
                            {{ form.weight }}
                            {% if form.weight.errors %}
                            <div class="invalid-feedback">
                                {{ form.weight.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <label for="{{ form.volume.id_for_label }}" class="form-label">Объем (м³)</label>
                            {{ form.volume }}
                            {% if form.volume.errors %}
                            <div class="invalid-feedback">
                                {{ form.volume.errors.0 }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Маркетплейс -->
                    <div class="mb-3">
                        <label for="{{ form.marketplace.id_for_label }}" class="form-label">Маркетплейс</label>
                        {{ form.marketplace }}
                        {% if form.marketplace.errors %}
                        <div class="invalid-feedback">
                            {{ form.marketplace.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Номер заказа в 1С -->
                    <div class="mb-3">
                        <label for="{{ form.order_1c_number.id_for_label }}" class="form-label">№ заказа в 1С</label>
                        {{ form.order_1c_number }}
                        {% if form.order_1c_number.errors %}
                        <div class="invalid-feedback">
                            {{ form.order_1c_number.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Желаемая дата поставки -->
                    <div class="mb-3">
                        <label for="id_desired_delivery_date" class="form-label">Желаемая дата поставки</label>
                        <input type="date" 
                               name="desired_delivery_date" 
                               id="id_desired_delivery_date" 
                               class="form-control {% if form.desired_delivery_date.errors %}is-invalid{% endif %}"
                               value="{% if form.desired_delivery_date.value %}{{ form.desired_delivery_date.value|date:'Y-m-d' }}{% elif object.desired_delivery_date %}{{ object.desired_delivery_date|date:'Y-m-d' }}{% endif %}"
                               min="{{ today|date:'Y-m-d' }}">
                        <small class="form-text text-muted">Когда клиент хочет получить заказ</small>
                        {% if form.desired_delivery_date.errors %}
                        <div class="invalid-feedback">
                            {{ form.desired_delivery_date.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Номер накладной -->
                    <div class="mb-3">
                        <label for="{{ form.invoice_number.id_for_label }}" class="form-label">Номер накладной</label>
                        {{ form.invoice_number }}
                        {% if form.invoice_number.errors %}
                        <div class="invalid-feedback">
                            {{ form.invoice_number.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Склад приемки -->
                    <div class="mb-3">
                        <label class="form-label">Склад приемки</label>
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   id="receivingWarehouseDisplay" 
                                   readonly
                                   placeholder="Нажмите кнопку для выбора склада приемки"
                                   value="{% if object.receiving_warehouse %}{{ object.receiving_warehouse.name }} ({{ object.receiving_warehouse.city.name }}){% endif %}">
                            <button type="button" class="btn btn-outline-secondary" onclick="openReceivingWarehouseModal()">
                                <i class="bi bi-geo-alt"></i> Выбрать склад
                            </button>
                        </div>
                        <small class="form-text text-muted">Склад, куда будет доставлен груз после забора</small>
                    </div>
                    
                    <!-- Оператор приемки -->
                    <div class="mb-3">
                        <label for="{{ form.receiving_operator.id_for_label }}" class="form-label">Оператор приемки</label>
                        <div class="input-group">
                            {{ form.receiving_operator }}
                            <button type="button" class="btn btn-outline-secondary" onclick="openOperatorModal()">
                                <i class="bi bi-person"></i> Выбрать
                            </button>
                        </div>
                        <small class="form-text text-muted">Оператор, который будет принимать груз на складе</small>
                        {% if form.receiving_operator.errors %}
                        <div class="invalid-feedback">
                            {{ form.receiving_operator.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Описание груза -->
                    <div class="mb-3">
                        <label for="{{ form.cargo_description.id_for_label }}" class="form-label">Описание груза</label>
                        {{ form.cargo_description }}
                        <small class="form-text text-muted">Дополнительная информация о заказе</small>
                        {% if form.cargo_description.errors %}
                        <div class="invalid-feedback">
                            {{ form.cargo_description.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Особые требования -->
                    <div class="mb-3">
                        <label for="{{ form.special_requirements.id_for_label }}" class="form-label">Особые требования</label>
                        {{ form.special_requirements }}
                        <small class="form-text text-muted">Хрупкий груз, температура, сроки и т.д.</small>
                        {% if form.special_requirements.errors %}
                        <div class="invalid-feedback">
                            {{ form.special_requirements.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Статус -->
                    <div class="mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label">Статус заявки</label>
                        {{ form.status }}
                        {% if form.status.errors %}
                        <div class="invalid-feedback">
                            {{ form.status.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Внутренние заметки -->
                    {% if object %}
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">Внутренние заметки</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="invalid-feedback">
                            {{ form.notes.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-4 pt-3 border-top">
                <button type="submit" class="btn btn-success">
                    {% if object %}Сохранить изменения{% else %}Создать заявку{% endif %}
                </button>
                <a href="{% if object %}{% url 'pickup_order_detail' object.pk %}{% else %}{% url 'pickup_order_list' %}{% endif %}" 
                   class="btn btn-secondary">Отмена</a>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно для выбора адреса забора -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">Выбор адреса забора</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="addressInput" class="form-label">Адрес</label>
          <textarea 
            class="form-control" 
            id="addressInput" 
            rows="3" 
            placeholder="Введите адрес вручную или выберите склад для автоматического заполнения"
          ></textarea>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="citySelect" class="form-label">Город</label>
              <select class="form-select" id="citySelect">
                <option value="">Выберите город</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="warehouseSelect" class="form-label">Склад</label>
              <select class="form-select" id="warehouseSelect" disabled>
                <option value="">Сначала выберите город</option>
              </select>
            </div>
          </div>
        </div>
        
        <div id="warehouseDetails" class="mt-3" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Информация о складе</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Название:</strong> <span id="warehouseName">-</span></p>
                  <p><strong>Адрес:</strong> <span id="warehouseAddress">-</span></p>
                  <p><strong>Телефон:</strong> <span id="warehousePhone">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Email:</strong> <span id="warehouseEmail">-</span></p>
                  <p><strong>График работы:</strong> <span id="warehouseHours">-</span></p>
                  <p><strong>Доступная площадь:</strong> <span id="warehouseArea">-</span> м²</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveAddressBtn">Выбрать</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для выбора склада приемки -->
<div class="modal fade" id="receivingWarehouseModal" tabindex="-1" aria-labelledby="receivingWarehouseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="receivingWarehouseModalLabel">Выбор склада приемки</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="receivingCitySelect" class="form-label">Город</label>
              <select class="form-select" id="receivingCitySelect">
                <option value="">Выберите город</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="receivingWarehouseSelect" class="form-label">Склад</label>
              <select class="form-select" id="receivingWarehouseSelect" disabled>
                <option value="">Сначала выберите город</option>
              </select>
            </div>
          </div>
        </div>
        
        <div id="receivingWarehouseDetails" class="mt-3" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Информация о складе</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Название:</strong> <span id="receivingWarehouseName">-</span></p>
                  <p><strong>Адрес:</strong> <span id="receivingWarehouseAddress">-</span></p>
                  <p><strong>Телефон:</strong> <span id="receivingWarehousePhone">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Email:</strong> <span id="receivingWarehouseEmail">-</span></p>
                  <p><strong>График работы:</strong> <span id="receivingWarehouseHours">-</span></p>
                  <p><strong>Доступная площадь:</strong> <span id="receivingWarehouseArea">-</span> м²</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveReceivingWarehouseBtn">Выбрать</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для выбора оператора приемки -->
<div class="modal fade" id="operatorModal" tabindex="-1" aria-labelledby="operatorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="operatorModalLabel">Выбор оператора приемки</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="operatorSearch" class="form-label">Поиск оператора</label>
          <input type="text" class="form-control" id="operatorSearch" placeholder="Введите имя, фамилию или логин...">
        </div>
        
        <div class="operator-list" style="max-height: 300px; overflow-y: auto;">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Выбрать</th>
                <th>ФИО</th>
                <th>Логин</th>
                <th>Роль</th>
              </tr>
            </thead>
            <tbody id="operatorList">
              <!-- Список операторов будет загружен здесь -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveOperatorBtn">Выбрать</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для создания контрагента -->
<div class="modal fade" id="counterpartyModal" tabindex="-1" aria-labelledby="counterpartyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="counterpartyModalLabel">Создание нового контрагента</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="counterpartyForm">
          {% csrf_token %}
          <input type="hidden" id="counterpartyFor" name="for" value="">
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyType" class="form-label">Тип контрагента *</label>
                <select class="form-select" id="counterpartyType" name="type" required onchange="changeCounterpartyType()">
                  <option value="legal">Юридическое лицо (ООО, АО)</option>
                  <option value="entrepreneur">Индивидуальный предприниматель (ИП)</option>
                  <option value="individual">Физическое лицо</option>
                  <option value="self_employed">Самозанятый</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyName" class="form-label">Наименование/ФИО *</label>
                <input type="text" class="form-control" id="counterpartyName" name="name" required>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="counterpartyFullName" class="form-label">Полное наименование</label>
            <input type="text" class="form-control" id="counterpartyFullName" name="full_name">
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyInn" class="form-label">ИНН</label>
                <input type="text" class="form-control" id="counterpartyInn" name="inn">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyPhone" class="form-label">Телефон</label>
                <input type="text" class="form-control" id="counterpartyPhone" name="phone">
              </div>
            </div>
          </div>
          
          <!-- Поля для юридического лица -->
          <div id="legalFields" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="counterpartyKpp" class="form-label">КПП</label>
                  <input type="text" class="form-control" id="counterpartyKpp" name="kpp">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="counterpartyOgrn" class="form-label">ОГРН</label>
                  <input type="text" class="form-control" id="counterpartyOgrn" name="ogrn">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Поля для физического лица -->
          <div id="individualFields" style="display: none;">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="counterpartyPassportSeries" class="form-label">Серия паспорта</label>
                  <input type="text" class="form-control" id="counterpartyPassportSeries" name="passport_series">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="counterpartyPassportNumber" class="form-label">Номер паспорта</label>
                  <input type="text" class="form-control" id="counterpartyPassportNumber" name="passport_number">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="counterpartyPassportIssuedBy" class="form-label">Кем выдан паспорт</label>
              <textarea class="form-control" id="counterpartyPassportIssuedBy" name="passport_issued_by" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="counterpartyPassportIssuedDate" class="form-label">Дата выдачи паспорта</label>
              <input type="date" class="form-control" id="counterpartyPassportIssuedDate" name="passport_issued_date">
            </div>
          </div>
          
          <!-- Общие поля -->
          <div class="mb-3">
            <label for="counterpartyAddress" class="form-label">Юридический адрес *</label>
            <textarea class="form-control" id="counterpartyAddress" name="address" rows="2" required></textarea>
          </div>
          
          <div class="mb-3">
            <label for="counterpartyActualAddress" class="form-label">Фактический адрес</label>
            <textarea class="form-control" id="counterpartyActualAddress" name="actual_address" rows="2"></textarea>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="counterpartyEmail" name="email">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="counterpartyContactPerson" class="form-label">Контактное лицо</label>
                <input type="text" class="form-control" id="counterpartyContactPerson" name="contact_person">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveCounterpartyBtn">Создать</button>
      </div>
    </div>
  </div>
</div>

<style>
.address-field {
    cursor: pointer !important;
    background-color: #f8f9fa !important;
    transition: background-color 0.2s;
}

.address-field:hover {
    background-color: #e9ecef !important;
    outline: 2px solid rgba(13, 110, 253, 0.3);
    outline-offset: -2px;
}

.warehouse-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-top: 10px;
}

.warehouse-item {
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.warehouse-item:hover {
    background-color: #f8f9fa;
}

.warehouse-item.selected {
    background-color: #e7f1ff;
    border-left: 3px solid #0d6efd;
}

.warehouse-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.warehouse-address {
    color: #666;
    font-size: 13px;
    margin-bottom: 2px;
    white-space: normal;
    word-break: break-word;
}

.warehouse-city {
    color: #888;
    font-size: 12px;
}

.time-range-row {
    display: flex;
    gap: 10px;
    align-items: center;
}

.time-range-row .form-control {
    flex: 1;
}

.time-separator-form {
    color: #666;
    font-weight: bold;
    min-width: 10px;
    text-align: center;
}

.counterparty-fields {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
}

.operator-list table tr {
    cursor: pointer;
}

.operator-list table tr:hover {
    background-color: #f8f9fa;
}

.operator-list table tr.selected {
    background-color: #e7f1ff;
}
</style>

<script>
let selectedWarehouseId = null;
let selectedReceivingWarehouseId = null;
let selectedOperatorId = null;
let addressModalInstance = null;
let receivingWarehouseModalInstance = null;
let operatorModalInstance = null;
let counterpartyModalInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    // Инициализация модальных окон
    initAddressModal();
    initReceivingWarehouseModal();
    initOperatorModal();
    initCounterpartyModal();
    
    // Делаем поле адреса забора кликабельным
    const pickupAddressField = document.getElementById('{{ form.pickup_address.id_for_label }}');
    if (pickupAddressField) {
        pickupAddressField.classList.add('address-field');
        pickupAddressField.setAttribute('readonly', 'readonly');
        pickupAddressField.setAttribute('onclick', 'openAddressModal()');
        pickupAddressField.setAttribute('placeholder', 'Нажмите для выбора адреса забора');
    }
    
    // Инициализация select2 для оператора приемки
    const receivingOperatorSelect = document.getElementById('{{ form.receiving_operator.id_for_label }}');
    if (receivingOperatorSelect) {
        // Если select2 доступен, инициализируем его
        if (typeof $.fn.select2 !== 'undefined') {
            $(receivingOperatorSelect).select2({
                placeholder: "Выберите оператора приемки",
                allowClear: true,
                width: '100%'
            });
        }
    }
});

function initAddressModal() {
    const modal = document.getElementById('addressModal');
    
    // Обработчик скрытия модального окна
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('citySelect').value = '';
        document.getElementById('warehouseSelect').value = '';
        document.getElementById('warehouseSelect').disabled = true;
        document.getElementById('warehouseDetails').style.display = 'none';
        document.getElementById('addressInput').value = '';
        selectedWarehouseId = null;
    });
    
    // Обработчик выбора города
    document.getElementById('citySelect').addEventListener('change', function() {
        const cityId = this.value;
        if (cityId) {
            loadWarehousesByCity(cityId, 'warehouseSelect', 'warehouseDetails');
            document.getElementById('warehouseDetails').style.display = 'none';
        } else {
            document.getElementById('warehouseSelect').value = '';
            document.getElementById('warehouseSelect').disabled = true;
            document.getElementById('warehouseDetails').style.display = 'none';
        }
    });
    
    // Обработчик выбора склада
    document.getElementById('warehouseSelect').addEventListener('change', function() {
        const warehouseId = this.value;
        if (warehouseId) {
            loadWarehouseDetails(warehouseId, 'warehouse');
        } else {
            document.getElementById('warehouseDetails').style.display = 'none';
            selectedWarehouseId = null;
            document.getElementById('addressInput').value = '';
        }
    });
    
    // Кнопка сохранения адреса
    document.getElementById('saveAddressBtn').addEventListener('click', function() {
        saveAddress();
    });
    
    // Сохранение по Ctrl+Enter
    document.getElementById('addressInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveAddress();
        }
    });
}

function initReceivingWarehouseModal() {
    const modal = document.getElementById('receivingWarehouseModal');
    
    // Обработчик скрытия модального окна
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('receivingCitySelect').value = '';
        document.getElementById('receivingWarehouseSelect').value = '';
        document.getElementById('receivingWarehouseSelect').disabled = true;
        document.getElementById('receivingWarehouseDetails').style.display = 'none';
        selectedReceivingWarehouseId = null;
    });
    
    // Обработчик выбора города
    document.getElementById('receivingCitySelect').addEventListener('change', function() {
        const cityId = this.value;
        if (cityId) {
            loadWarehousesByCity(cityId, 'receivingWarehouseSelect', 'receivingWarehouseDetails');
            document.getElementById('receivingWarehouseDetails').style.display = 'none';
        } else {
            document.getElementById('receivingWarehouseSelect').value = '';
            document.getElementById('receivingWarehouseSelect').disabled = true;
            document.getElementById('receivingWarehouseDetails').style.display = 'none';
        }
    });
    
    // Обработчик выбора склада
    document.getElementById('receivingWarehouseSelect').addEventListener('change', function() {
        const warehouseId = this.value;
        if (warehouseId) {
            loadWarehouseDetails(warehouseId, 'receivingWarehouse');
        } else {
            document.getElementById('receivingWarehouseDetails').style.display = 'none';
            selectedReceivingWarehouseId = null;
        }
    });
    
    // Кнопка сохранения склада приемки
    document.getElementById('saveReceivingWarehouseBtn').addEventListener('click', function() {
        saveReceivingWarehouse();
    });
}

function initOperatorModal() {
    const modal = document.getElementById('operatorModal');
    
    // Обработчик скрытия модального окна
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('operatorSearch').value = '';
        document.getElementById('operatorList').innerHTML = '';
        selectedOperatorId = null;
    });
    
    // Поиск операторов
    document.getElementById('operatorSearch').addEventListener('input', function() {
        loadOperators(this.value);
    });
    
    // Кнопка сохранения оператора
    document.getElementById('saveOperatorBtn').addEventListener('click', function() {
        saveOperator();
    });
}

function initCounterpartyModal() {
    const modal = document.getElementById('counterpartyModal');
    
    // Обработчик скрытия модального окна
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('counterpartyForm').reset();
        document.getElementById('legalFields').style.display = 'none';
        document.getElementById('individualFields').style.display = 'none';
        document.getElementById('counterpartyFor').value = '';
    });
    
    // Кнопка сохранения контрагента
    document.getElementById('saveCounterpartyBtn').addEventListener('click', function() {
        saveCounterparty();
    });
    
    // Сохранение по Ctrl+Enter
    document.getElementById('counterpartyForm').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveCounterparty();
        }
    });
}

function openAddressModal() {
    // Заполняем текущий адрес в модальном окне
    const currentAddress = document.getElementById('{{ form.pickup_address.id_for_label }}').value;
    document.getElementById('addressInput').value = currentAddress;
    
    // Загружаем города
    loadCities('citySelect');
    
    // Открываем модальное окно
    const modalElement = document.getElementById('addressModal');
    addressModalInstance = new bootstrap.Modal(modalElement);
    addressModalInstance.show();
}

function openReceivingWarehouseModal() {
    // Загружаем города
    loadCities('receivingCitySelect');
    
    // Открываем модальное окно
    const modalElement = document.getElementById('receivingWarehouseModal');
    receivingWarehouseModalInstance = new bootstrap.Modal(modalElement);
    receivingWarehouseModalInstance.show();
}

function openOperatorModal() {
    // Загружаем операторов
    loadOperators('');
    
    // Открываем модальное окно
    const modalElement = document.getElementById('operatorModal');
    operatorModalInstance = new bootstrap.Modal(modalElement);
    operatorModalInstance.show();
}

function openCounterpartyModal(forField) {
    // Устанавливаем для какого поля создаем контрагента
    document.getElementById('counterpartyFor').value = forField;
    
    // Открываем модальное окно
    const modalElement = document.getElementById('counterpartyModal');
    counterpartyModalInstance = new bootstrap.Modal(modalElement);
    counterpartyModalInstance.show();
}

function changeCounterpartyType() {
    const type = document.getElementById('counterpartyType').value;
    const legalFields = document.getElementById('legalFields');
    const individualFields = document.getElementById('individualFields');
    
    // Скрываем все поля
    legalFields.style.display = 'none';
    individualFields.style.display = 'none';
    
    // Показываем нужные поля в зависимости от типа
    if (type === 'legal') {
        legalFields.style.display = 'block';
    } else if (type === 'individual') {
        individualFields.style.display = 'block';
    }
}

function loadCities(selectId) {
    const citySelect = document.getElementById(selectId);
    
    fetch('{% url "cities_json" %}')
        .then(response => response.json())
        .then(data => {
            citySelect.innerHTML = '<option value="">Выберите город</option>';
            data.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки городов:', error);
            showNotification('Ошибка загрузки списка городов', 'error');
        });
}

function loadWarehousesByCity(cityId, selectId, detailsId) {
    const warehouseSelect = document.getElementById(selectId);
    
    fetch(`{% url "warehouses_by_city_json" 0 %}`.replace('0', cityId))
        .then(response => response.json())
        .then(data => {
            warehouseSelect.innerHTML = '<option value="">Выберите склад</option>';
            data.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                warehouseSelect.appendChild(option);
            });
            warehouseSelect.disabled = false;
        })
        .catch(error => {
            console.error('Ошибка загрузки складов:', error);
            showNotification('Ошибка загрузки списка складов', 'error');
        });
}

function loadWarehouseDetails(warehouseId, prefix) {
    fetch(`{% url "warehouse_details_json" 0 %}`.replace('0', warehouseId))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Ошибка загрузки деталей склада:', data.error);
                return;
            }
            
            document.getElementById(`${prefix}Name`).textContent = data.name;
            document.getElementById(`${prefix}Address`).textContent = data.address;
            document.getElementById(`${prefix}Phone`).textContent = data.phone;
            document.getElementById(`${prefix}Email`).textContent = data.email || 'Не указан';
            document.getElementById(`${prefix}Hours`).textContent = data.working_hours;
            document.getElementById(`${prefix}Area`).textContent = data.available_area;
            
            document.getElementById(`${prefix}Details`).style.display = 'block';
            
            // Сохраняем выбранный склад
            if (prefix === 'warehouse') {
                selectedWarehouseId = warehouseId;
                // Автоматическое заполнение адреса
                if (data.address && data.address !== '-') {
                    document.getElementById('addressInput').value = data.address;
                }
            } else if (prefix === 'receivingWarehouse') {
                selectedReceivingWarehouseId = warehouseId;
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки деталей склада:', error);
        });
}

function loadOperators(searchTerm) {
    const operatorList = document.getElementById('operatorList');
    
    let url = '{% url "get_operators" %}';
    if (searchTerm) {
        url += `?search=${encodeURIComponent(searchTerm)}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            operatorList.innerHTML = '';
            data.forEach(operator => {
                const row = document.createElement('tr');
                row.setAttribute('data-operator-id', operator.id);
                row.innerHTML = `
                    <td>
                        <input type="radio" name="selectedOperator" value="${operator.id}">
                    </td>
                    <td>${operator.full_name}</td>
                    <td>${operator.username}</td>
                    <td>
                        <span class="badge bg-info">
                            ${operator.role === 'operator' ? 'Оператор' : 
                              operator.role === 'logistic' ? 'Логист' : 
                              operator.role === 'admin' ? 'Администратор' : 'Неизвестно'}
                        </span>
                    </td>
                `;
                
                row.addEventListener('click', function() {
                    // Снимаем выделение со всех строк
                    document.querySelectorAll('#operatorList tr').forEach(tr => {
                        tr.classList.remove('selected');
                        tr.querySelector('input[type="radio"]').checked = false;
                    });
                    
                    // Выделяем текущую строку
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    selectedOperatorId = operator.id;
                });
                
                operatorList.appendChild(row);
            });
            
            if (data.length === 0) {
                operatorList.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted">
                            Операторы не найдены
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки операторов:', error);
            operatorList.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">
                        Ошибка загрузки операторов
                    </td>
                </tr>
            `;
        });
}

function saveAddress() {
    const addressInput = document.getElementById('addressInput').value.trim();
    
    if (!addressInput) {
        showNotification('Пожалуйста, введите адрес', 'error');
        return;
    }
    
    // Заполняем поле адреса в форме
    const pickupAddressField = document.getElementById('{{ form.pickup_address.id_for_label }}');
    if (pickupAddressField) {
        pickupAddressField.value = addressInput;
    }
    
    // Закрываем модальное окно
    if (addressModalInstance) {
        addressModalInstance.hide();
    } else {
        const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showNotification('Адрес успешно выбран', 'success');
}

function saveReceivingWarehouse() {
    if (!selectedReceivingWarehouseId) {
        showNotification('Пожалуйста, выберите склад', 'error');
        return;
    }
    
    // Заполняем скрытое поле для склада приемки
    document.getElementById('{{ form.receiving_warehouse.id_for_label }}').value = selectedReceivingWarehouseId;
    
    // Заполняем поле для отображения
    const warehouseName = document.getElementById('receivingWarehouseName').textContent;
    const warehouseCity = document.querySelector('#receivingCitySelect option:checked').textContent;
    document.getElementById('receivingWarehouseDisplay').value = `${warehouseName} (${warehouseCity})`;
    
    // Закрываем модальное окно
    if (receivingWarehouseModalInstance) {
        receivingWarehouseModalInstance.hide();
    } else {
        const modal = bootstrap.Modal.getInstance(document.getElementById('receivingWarehouseModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showNotification('Склад приемки успешно выбран', 'success');
}

function saveOperator() {
    if (!selectedOperatorId) {
        showNotification('Пожалуйста, выберите оператора', 'error');
        return;
    }
    
    // Заполняем поле оператора приемки
    const receivingOperatorSelect = document.getElementById('{{ form.receiving_operator.id_for_label }}');
    if (receivingOperatorSelect) {
        receivingOperatorSelect.value = selectedOperatorId;
        
        // Обновляем select2 если он инициализирован
        if (typeof $.fn.select2 !== 'undefined' && $(receivingOperatorSelect).hasClass('select2-hidden-accessible')) {
            $(receivingOperatorSelect).trigger('change');
        }
    }
    
    // Закрываем модальное окно
    if (operatorModalInstance) {
        operatorModalInstance.hide();
    } else {
        const modal = bootstrap.Modal.getInstance(document.getElementById('operatorModal'));
        if (modal) {
            modal.hide();
        }
    }
    
    showNotification('Оператор приемки успешно выбран', 'success');
}

function saveCounterparty() {
    const form = document.getElementById('counterpartyForm');
    const formData = new FormData(form);
    const forField = document.getElementById('counterpartyFor').value;
    
    // Проверяем обязательные поля
    if (!formData.get('name')) {
        showNotification('Пожалуйста, введите наименование/ФИО', 'error');
        return;
    }
    
    if (!formData.get('address')) {
        showNotification('Пожалуйста, введите адрес', 'error');
        return;
    }
    
    // Отправляем запрос на создание контрагента
    fetch('{% url "create_counterparty_api" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Добавляем нового контрагента в выпадающий список
            const selectField = document.getElementById(`id_${forField}`);
            if (selectField) {
                const newOption = document.createElement('option');
                newOption.value = data.id;
                newOption.textContent = data.short_info;
                newOption.selected = true;
                selectField.appendChild(newOption);
            }
            
            // Закрываем модальное окно
            if (counterpartyModalInstance) {
                counterpartyModalInstance.hide();
            } else {
                const modal = bootstrap.Modal.getInstance(document.getElementById('counterpartyModal'));
                if (modal) {
                    modal.hide();
                }
            }
            
            showNotification('Контрагент успешно создан', 'success');
        } else {
            showNotification(`Ошибка при создании контрагента: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Ошибка при создании контрагента:', error);
        showNotification('Ошибка при создании контрагента', 'error');
    });
}

function showNotification(message, type) {
    // Удаляем старые уведомления
    const oldNotifications = document.querySelectorAll('.notification-alert');
    oldNotifications.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
    
    // Создаем новое уведомление
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-alert`;
    alert.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            ${type === 'success' ? 
                '<i class="bi bi-check-circle-fill me-2 fs-5"></i>' : 
                '<i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>'
            }
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Вставляем в body
    document.body.appendChild(alert);
    
    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        if (alert.parentNode) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}
</script>
{% endblock %}