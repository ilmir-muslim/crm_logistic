{% extends 'base.html' %}

{% block content %}
{% if is_operator %}
<div class="operator-view">
{% endif %}

<h2 class="mb-4">–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞</h2>

{% if is_operator %}
<div class="alert alert-info">
    <strong>–†–µ–∂–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:</strong> –í—ã –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–∞—è–≤–∫–∏. 
    –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: {{ orders.count }}
</div>
{% endif %}

{% if is_logistic %}
<div class="alert alert-warning">
    <strong>–†–µ–∂–∏–º –ª–æ–≥–∏—Å—Ç–∞:</strong> –í—ã –≤–∏–¥–∏—Ç–µ –≤—Å–µ –∑–∞—è–≤–∫–∏. 
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞.
</div>
{% endif %}

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
        transition: background-color 0.2s ease;
    }
    
    .sortable-header:hover {
        background-color: #444 !important; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –Ω–∞ —á–µ—Ä–Ω–æ–º —Ñ–æ–Ω–µ */
    }
    
    .sort-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        opacity: 0.7;
        color: #ffffff;
    }
    
    .sortable-header.sorted-asc .sort-icon::after {
        content: "‚Üë";
        color: #28a745; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞—é—â–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        opacity: 1;
        font-weight: bold;
    }
    
    .sortable-header.sorted-desc .sort-icon::after {
        content: "‚Üì";
        color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —É–±—ã–≤–∞—é—â–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        opacity: 1;
        font-weight: bold;
    }
    
    .sortable-header:hover .sort-icon {
        opacity: 0.9;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .editable-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s;
        padding: 8px !important;
        min-height: 40px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: normal !important;
        color: #212529 !important;
    }

    .editable-cell:hover {
        background-color: rgba(13, 110, 253, 0.1) !important;
        outline: 2px solid rgba(13, 110, 253, 0.3);
        outline-offset: -2px;
    }

    .editable-cell.editing {
        background-color: rgba(255, 255, 204, 0.3) !important;
        padding: 0 !important;
    }

    .editable-input {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-select {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-date {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-time {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .save-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: #198754;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 10;
        transition: all 0.2s;
    }

    .save-btn:hover {
        background: #157347;
    }

    .editing .save-btn {
        display: block;
    }

    .cancel-btn {
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 10;
        transition: all 0.2s;
    }

    .cancel-btn:hover {
        background: #c82333;
    }

    .editing .cancel-btn {
        display: block;
    }

    .status-badge-editable {
        cursor: pointer;
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 15px !important;
        font-weight: normal !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        transition: all 0.2s;
    }

    .status-badge-editable:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .inline-input-container {
        position: relative;
        padding: 6px 10px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 300px;
        max-width: 400px;
    }

    /* –ï–¥–∏–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –¥–ª—è –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã */
    .table th {
        white-space: nowrap;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: 600 !important;
        color: #fff !important;
    }

    .table td {
        vertical-align: middle;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: normal !important;
        color: #212529 !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
    .status-ready { 
        color: #0dcaf0 !important; 
    }
    .status-payment { 
        color: #ffc107 !important; 
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –Ω–∞–∫–ª–∞–¥–Ω–æ–π */
    .invoice-number {
        font-family: monospace;
        color: #495057;
        font-weight: normal;
        font-size: 15px !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */
    .operator-name {
        font-weight: normal;
        color: #495057;
        font-size: 15px !important;
    }

    /* –£–±–∏—Ä–∞–µ–º Bootstrap —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–≥–∞ code */
    table code {
        color: inherit !important;
        background-color: transparent !important;
        font-family: inherit !important;
        font-size: inherit !important;
        padding: 0 !important;
        border: none !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–≥–∞ code –≤ —Ç–∞–±–ª–∏—Ü–µ */
    .editable-cell code {
        color: inherit !important;
        background-color: transparent !important;
        font-family: inherit !important;
        font-size: inherit !important;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –ø–æ–ª–æ—Å–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
    .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(0, 0, 0, 0.02);
    }

    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞ */
    .table th,
    .table td {
        padding: 12px 10px !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .btn-group-sm .btn {
        font-size: 14px !important;
        padding: 4px 8px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
    .pagination .page-link {
        font-size: 15px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .form-control, .form-select {
        font-size: 15px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .card-header h5, .card-header h6 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: 600 !important;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) */
    .operator-view .editable-cell {
        cursor: default !important;
    }

    .operator-view .editable-cell:hover {
        background-color: inherit !important;
        outline: none !important;
    }

    .operator-view .status-badge-editable {
        cursor: default !important;
        pointer-events: none !important;
    }

    .operator-view .status-badge-editable:hover {
        transform: none !important;
        box-shadow: none !important;
    }

    /* –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ */
    .operator-view .save-btn,
    .operator-view .cancel-btn {
        display: none !important;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–¥—Ä–µ—Å–∞ */
    #addressModal .card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    #addressModal .card-body p {
        margin-bottom: 0.5rem;
        font-size: 14px;
    }

    #addressModal .card-body strong {
        color: #495057;
        min-width: 120px;
        display: inline-block;
    }

    #warehouseDetails {
        transition: all 0.3s ease;
    }

    .warehouse-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 10px;
    }

    .warehouse-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .warehouse-item:hover {
        background-color: #f8f9fa;
    }

    .warehouse-item.selected {
        background-color: #e7f1ff;
        border-left: 3px solid #0d6efd;
    }

    .warehouse-name {
        font-weight: 600;
        margin-bottom: 2px;
    }

    .warehouse-address {
        color: #666;
        font-size: 13px;
        margin-bottom: 2px;
        white-space: normal;
        word-break: break-word;
    }

    .warehouse-city {
        color: #888;
        font-size: 12px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è –∞–¥—Ä–µ—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
    #addressInput {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 15px;
        line-height: 1.5;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∏–∫–æ–Ω–∫–∏ —Å–∫–ª–∞–¥–∞ */
    .badge.bg-info {
        font-size: 10px;
        padding: 2px 5px;
        cursor: help;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏ */
    .time-range-container {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 6px 0;
    }
    
    .time-separator {
        color: #666;
        font-weight: bold;
        min-width: 10px;
        text-align: center;
    }
    
    .time-input-wrapper {
        flex: 1;
        min-width: 0;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .table th,
        .table td {
            padding: 8px 6px !important;
            font-size: 15px !important;
        }
        
        .editable-cell {
            font-size: 15px !important;
        }
        
        .status-badge-editable {
            font-size: 14px !important;
        }
        
        .btn-group-sm .btn {
            font-size: 13px !important;
            padding: 3px 6px !important;
        }
        
        .invoice-number {
            font-size: 14px !important;
        }
        
        .operator-name {
            font-size: 14px !important;
        }
        
        .sort-icon {
            right: 4px;
            font-size: 10px;
        }
        
        #addressModal .modal-dialog {
            margin: 0.5rem;
        }
        
        .warehouse-list {
            max-height: 200px;
        }
        
        .time-range-container {
            flex-direction: column;
            gap: 4px;
        }
        
        .time-input-wrapper {
            width: 100%;
        }
    }
</style>

<!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">–§–∏–ª—å—Ç—Ä—ã</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">–î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞ –æ—Ç</label>
                <input type="date" name="pickup_date__gte" class="form-control" value="{{ request.GET.pickup_date__gte }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">–î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞ –¥–æ</label>
                <input type="date" name="pickup_date__lte" class="form-control" value="{{ request.GET.pickup_date__lte }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">–ö–ª–∏–µ–Ω—Ç</label>
                <input type="text" name="client_name" class="form-control" 
                       value="{{ request.GET.client_name }}" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
            </div>
            <div class="col-md-2">
                <label class="form-label">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</label>
                <input type="text" name="pickup_address" class="form-control" 
                       value="{{ request.GET.pickup_address }}" placeholder="–ê–¥—Ä–µ—Å">
            </div>
            <div class="col-md-2">
                <label class="form-label">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π</label>
                <input type="text" name="invoice_number" class="form-control" 
                       value="{{ request.GET.invoice_number }}" placeholder="–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π">
            </div>
            <div class="col-md-2">
                <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select name="status" class="form-select">
                    <option value="">–í—Å–µ</option>
                    <option value="ready" {% if request.GET.status == 'ready' %}selected{% endif %}>–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ</option>
                    <option value="payment" {% if request.GET.status == 'payment' %}selected{% endif %}>–ù–∞ –æ–ø–ª–∞—Ç–µ</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
                <a href="{% url 'pickup_order_list' %}" class="btn btn-outline-secondary ms-2">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </form>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="card mb-3">
    <div class="card-header bg-light">
        <h6 class="mb-0">–ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
    </div>
    <div class="card-body">
        <form id="bulkActionsForm" method="get" action="{% url 'pickup_orders_bulk_pdf' %}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllBtn">
                        <i class="bi bi-check-square"></i> –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" id="deselectAllBtn">
                        <i class="bi bi-square"></i> –°–Ω—è—Ç—å –≤—ã–±–æ—Ä
                    </button>
                    <span class="ms-3 text-muted" id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0</span>
                </div>
                <div>
                    <a href="{% url 'pickup_order_create' %}" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
                    </a>
                    <button type="submit" class="btn btn-danger" id="exportPdfBtn" disabled>
                        <i class="bi bi-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ PDF
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Å —á–µ–∫–±–æ–∫—Å–∞–º–∏ –∏ –∏–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º -->
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                </th>
                <th class="sortable-header {% if sort == 'invoice_number' %}sorted-{{ order }}{% endif %}" 
                    data-sort="invoice_number">
                    –ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'pickup_date' %}sorted-{{ order }}{% endif %}" 
                    data-sort="pickup_date">
                    –î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'pickup_time_from' %}sorted-{{ order }}{% endif %}" 
                    data-sort="pickup_time_from">
                    –í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'pickup_address' %}sorted-{{ order }}{% endif %}" 
                    data-sort="pickup_address">
                    –ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'contact_person' %}sorted-{{ order }}{% endif %}" 
                    data-sort="contact_person">
                    –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'desired_delivery_date' %}sorted-{{ order }}{% endif %}" 
                    data-sort="desired_delivery_date">
                    –î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'status' %}sorted-{{ order }}{% endif %}" 
                    data-sort="status">
                    –°—Ç–∞—Ç—É—Å
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'client_name' %}sorted-{{ order }}{% endif %}" 
                    data-sort="client_name">
                    –ö–ª–∏–µ–Ω—Ç
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'operator' %}sorted-{{ order }}{% endif %}" 
                    data-sort="operator">
                    –û–ø–µ—Ä–∞—Ç–æ—Ä
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'quantity' %}sorted-{{ order }}{% endif %}" 
                    data-sort="quantity">
                    –ú–µ—Å—Ç–∞
                    <span class="sort-icon"></span>
                </th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr data-order-id="{{ order.id }}" data-order-type="pickup">
                <td>
                    <input type="checkbox" name="order_ids" value="{{ order.id }}" 
                           class="form-check-input order-checkbox">
                </td>
                <td class="editable-cell" data-field="invoice_number" data-original="{{ order.invoice_number|default:'' }}">
                    {% if order.invoice_number %}
                        <span class="invoice-number">{{ order.invoice_number }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="pickup_date" data-original="{{ order.pickup_date|date:'Y-m-d' }}" data-type="date">
                    {% if order.pickup_date %}
                        {{ order.pickup_date|date:"d.m.Y" }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell editable-time-range" 
                    data-field-from="pickup_time_from" 
                    data-field-to="pickup_time_to"
                    data-original-from="{{ order.pickup_time_from|time:'H:i'|default:'' }}" 
                    data-original-to="{{ order.pickup_time_to|time:'H:i'|default:'' }}">
                    {{ order.pickup_time_range }}
                    <button class="save-btn" onclick="saveTimeRangeCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="pickup_address" data-original="{{ order.pickup_address }}" data-full-address="{{ order.pickup_address }}">
                    {{ order.pickup_address|truncatechars:30 }}
                    {% if order.receiving_warehouse %}
                        <span class="badge bg-info ms-2" title="–°–∫–ª–∞–¥: {{ order.receiving_warehouse.name }} ({{ order.receiving_warehouse.city.name }})">üì¶</span>
                    {% endif %}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="contact_person" data-original="{{ order.contact_person|default:order.client_name }}">
                    {{ order.contact_person|default:order.client_name|truncatechars:20 }}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="desired_delivery_date" data-original="{{ order.desired_delivery_date|date:'Y-m-d'|default:'' }}" data-type="date">
                    {% if order.desired_delivery_date %}
                        {{ order.desired_delivery_date|date:"d.m.Y" }}
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="status" data-original="{{ order.status }}" data-type="select">
                    <span class="status-badge-editable status-{{ order.status }}" onclick="startEditStatus(this)">
                        {{ order.get_status_display }}
                    </span>
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="client_name" data-original="{{ order.client_name }}">
                    {{ order.client_name|truncatechars:20 }}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="operator" data-original="{{ order.operator.id|default:'' }}" data-type="select">
                    {% if order.operator %}
                        <span class="operator-name">{{ order.operator.get_full_name|default:order.operator.username|truncatechars:20 }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td class="editable-cell" data-field="quantity" data-original="{{ order.quantity }}" data-type="number">
                    {{ order.quantity }}
                    <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'pickup_order_detail' order.pk %}" 
                        class="btn btn-outline-info">–ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ "–ò–∑–º–µ–Ω–∏—Ç—å" —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ -->
                        {% if not is_operator %}
                        <a href="{% url 'pickup_order_update' order.pk %}" 
                        class="btn btn-outline-warning">–ò–∑–º–µ–Ω–∏—Ç—å</a>
                        {% endif %}
                        
                        <a href="{% url 'pickup_order_pdf' order.pk %}" 
                        class="btn btn-outline-danger">
                            <i class="bi bi-file-pdf"></i>
                        </a>
                        {% if order.is_convertible_to_delivery %}
                        <a href="{% url 'convert_to_delivery' order.pk %}" 
                        class="btn btn-outline-success">
                            <i class="bi bi-truck"></i>
                        </a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="12" class="text-center py-4" style="font-size: 15px;">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">–ù–∞–∑–∞–¥</a>
        </li>
        {% endif %}
        
        <li class="page-item disabled">
            <span class="page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">–í–ø–µ—Ä–µ–¥</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞ -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∑–∞–±–æ—Ä–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –∞–¥—Ä–µ—Å–∞ -->
        <div class="mb-3">
          <label for="addressInput" class="form-label">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</label>
          <textarea 
            class="form-control" 
            id="addressInput" 
            rows="3" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞..."
          ></textarea>
          <div class="form-text">–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Å–∫–ª–∞–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–¥—Ä–µ—Å–∞</div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="citySelect" class="form-label">–ì–æ—Ä–æ–¥</label>
              <select class="form-select" id="citySelect">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="warehouseSelect" class="form-label">–°–∫–ª–∞–¥</label>
              <select class="form-select" id="warehouseSelect" disabled>
                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ —Å –∞–¥—Ä–µ—Å–∞–º–∏ -->
        <div id="warehouseList" class="mt-3" style="display: none;">
          <h6 class="mb-2">–°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ:</h6>
          <div class="warehouse-list" id="warehouseItemsContainer">
            <!-- –°–∫–ª–∞–¥—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
          </div>
        </div>
        
        <div id="warehouseDetails" class="mt-3" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> <span id="warehouseName">-</span></p>
                  <p><strong>–ê–¥—Ä–µ—Å:</strong> <span id="warehouseAddress">-</span></p>
                  <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> <span id="warehousePhone">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Email:</strong> <span id="warehouseEmail">-</span></p>
                  <p><strong>–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:</strong> <span id="warehouseHours">-</span></p>
                  <p><strong>–î–æ—Å—Ç—É–ø–Ω–∞—è –ø–ª–æ—â–∞–¥—å:</strong> <span id="warehouseArea">-</span> –º¬≤</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="saveAddressBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–¥—Ä–µ—Å</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const selectedCount = document.getElementById('selectedCount');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    const bulkActionsForm = document.getElementById('bulkActionsForm');
    
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.order-checkbox:checked');
        selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selected.length}`;
        exportPdfBtn.disabled = selected.length === 0;
    }
    
    selectAllCheckbox.addEventListener('change', function() {
        orderCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    selectAllBtn.addEventListener('click', function() {
        orderCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        selectAllCheckbox.checked = true;
        updateSelectedCount();
    });
    
    deselectAllBtn.addEventListener('click', function() {
        orderCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectAllCheckbox.checked = false;
        updateSelectedCount();
    });
    
    orderCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    bulkActionsForm.addEventListener('submit', function(e) {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞—è–≤–∫—É');
            return;
        }
        
        const oldInputs = this.querySelectorAll('input[name="order_ids"]');
        oldInputs.forEach(input => input.remove());
        
        selectedCheckboxes.forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'order_ids';
            hiddenInput.value = checkbox.value;
            this.appendChild(hiddenInput);
        });
    });
    
    updateSelectedCount();
});
</script>

<!-- JavaScript –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sortableHeaders = document.querySelectorAll('.sortable-header');
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortField = this.getAttribute('data-sort');
            const currentUrl = new URL(window.location.href);
            const currentSort = currentUrl.searchParams.get('sort') || 'pickup_date';
            const currentOrder = currentUrl.searchParams.get('order') || 'desc';
            
            let newOrder = 'asc';
            
            if (currentSort === sortField) {
                // –ú–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            currentUrl.searchParams.set('sort', sortField);
            currentUrl.searchParams.set('order', newOrder);
            
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π URL
            window.location.href = currentUrl.toString();
        });
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const canEdit = !{{ is_operator|yesno:"true,false" }}; // –û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    
    if (!canEdit) {
        // –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –æ—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editableCells = document.querySelectorAll('.editable-cell');
        editableCells.forEach(cell => {
            // –£–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–æ—Ä-—É–∫–∞–∑–∞—Ç–µ–ª—å
            cell.style.cursor = 'default';
            // –£–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
            cell.style.transition = 'none';
            
            // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            cell.onclick = null;
            cell.ondblclick = null;
            cell.onmouseenter = null;
            cell.onmouseleave = null;
            
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å editable-cell
            cell.classList.remove('editable-cell');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–æ—Ç–º–µ–Ω—ã –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            const saveBtn = cell.querySelector('.save-btn');
            const cancelBtn = cell.querySelector('.cancel-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        });
        
        // –û—Ç–∫–ª—é—á–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
        const statusBadges = document.querySelectorAll('.status-badge-editable');
        statusBadges.forEach(badge => {
            badge.style.cursor = 'default';
            badge.onclick = null;
            badge.style.pointerEvents = 'none';
        });
    }
});
</script>

<!-- JavaScript –¥–ª—è –∏–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–¥—Ä–µ—Å–∞ -->
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
let editingCell = null;
let operatorsList = [];
let currentAddressCell = null;
let currentAddressField = null;

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
    const isOperator = {{ is_operator|yesno:"true,false" }};
    
    if (!isOperator) {
        // –¢–æ–ª—å–∫–æ –¥–ª—è –Ω–µ-–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–ª–æ–≥–∏—Å—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        initInlineEditing();
        initAddressModal();
        loadOperatorsList();
    }
});

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ê–î–†–ï–°–ê ====================

function initAddressModal() {
    const modal = document.getElementById('addressModal');
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('citySelect').value = '';
        document.getElementById('warehouseSelect').value = '';
        document.getElementById('warehouseSelect').disabled = true;
        document.getElementById('warehouseList').style.display = 'none';
        document.getElementById('warehouseDetails').style.display = 'none';
        document.getElementById('addressInput').value = '';
        document.getElementById('warehouseItemsContainer').innerHTML = '';
        currentAddressCell = null;
        currentAddressField = null;
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    modal.addEventListener('show.bs.modal', function() {
        loadCities();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞
    document.getElementById('citySelect').addEventListener('change', function() {
        const cityId = this.value;
        if (cityId) {
            loadWarehousesByCity(cityId);
            document.getElementById('warehouseDetails').style.display = 'none';
        } else {
            document.getElementById('warehouseSelect').value = '';
            document.getElementById('warehouseSelect').disabled = true;
            document.getElementById('warehouseList').style.display = 'none';
            document.getElementById('warehouseDetails').style.display = 'none';
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞
    document.getElementById('warehouseSelect').addEventListener('change', function() {
        const warehouseId = this.value;
        if (warehouseId) {
            loadWarehouseDetails(warehouseId);
        } else {
            document.getElementById('warehouseDetails').style.display = 'none';
        }
    });
    
    // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞
    document.getElementById('saveAddressBtn').addEventListener('click', function() {
        saveAddressFromModal();
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ Ctrl+Enter
    document.getElementById('addressInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveAddressFromModal();
        }
    });
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —è—á–µ–π–∫—É –∞–¥—Ä–µ—Å–∞
function openAddressModal(cell, field) {
    currentAddressCell = cell;
    currentAddressField = field;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–¥—Ä–µ—Å –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
    const currentAddress = cell.getAttribute('data-original') || '';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞
    document.getElementById('addressInput').value = currentAddress;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
    if (currentAddress) {
    }
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('addressModal'));
    modal.show();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function saveAddressFromModal() {
    if (!currentAddressCell || !currentAddressField) return;
    
    const newAddress = document.getElementById('addressInput').value.trim();
    const warehouseSelect = document.getElementById('warehouseSelect');
    const selectedWarehouseId = warehouseSelect.value;
    const selectedWarehouseText = warehouseSelect.options[warehouseSelect.selectedIndex].text;
    
    if (!newAddress) {
        showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å', 'error');
        return;
    }
    
    const orderId = currentAddressCell.closest('tr').getAttribute('data-order-id');
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–±–∞ –ø–æ–ª—è
    if (selectedWarehouseId) {
        updateOrderWarehouseAndAddress(currentAddressCell, selectedWarehouseId, newAddress, selectedWarehouseText);
    } else {
        // –ò–Ω–∞—á–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å
        updateOrderAddressOnly(currentAddressCell, newAddress, orderId, currentAddressField);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–∞ (–±–µ–∑ —Å–∫–ª–∞–¥–∞)
function updateOrderAddressOnly(cell, address, orderId, field) {
    const csrfToken = getCookie('csrftoken');
    const url = `{% url 'pickup_order_update_field' 0 %}`.replace('0', orderId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ
            updateCellDisplay(cell, field, address, data.display_value || address, 'text');
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
            modal.hide();
            
            showNotification('–ê–¥—Ä–µ—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞: ' + error.message, 'error');
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –∏ –∞–¥—Ä–µ—Å–∞
function updateOrderWarehouseAndAddress(cell, warehouseId, address, warehouseText) {
    const orderId = cell.closest('tr').getAttribute('data-order-id');
    const csrfToken = getCookie('csrftoken');
    const url = `{% url 'pickup_order_update_field' 0 %}`.replace('0', orderId);
    const field = currentAddressField;
    
    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–ª–∞–¥
    updateField(orderId, 'receiving_warehouse', warehouseId, url)
        .then(() => {
            // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –∞–¥—Ä–µ—Å
            return updateField(orderId, field, address, url);
        })
        .then((data) => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ
                updateCellDisplay(cell, field, address, data.display_value || address, 'text');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —Å–∫–ª–∞–¥–∞
                const existingBadge = cell.querySelector('.badge.bg-info');
                if (!existingBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-info ms-2';
                    badge.title = `–°–∫–ª–∞–¥: ${warehouseText}`;
                    badge.innerHTML = 'üì¶';
                    cell.querySelector('.address-text').after(badge);
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
                modal.hide();
                
                showNotification('–ê–¥—Ä–µ—Å –∏ —Å–∫–ª–∞–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞ –∏ –∞–¥—Ä–µ—Å–∞:', error);
            showNotification('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        });
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—è
function updateField(orderId, field, value, url) {
    const csrfToken = getCookie('csrftoken');
    
    return fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: value
        })
    })
    .then(response => response.json());
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤
function loadCities() {
    const citySelect = document.getElementById('citySelect');
    
    fetch('{% url "cities_json" %}')
        .then(response => response.json())
        .then(data => {
            citySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>';
            data.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤', 'error');
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤ –ø–æ –≥–æ—Ä–æ–¥—É
function loadWarehousesByCity(cityId) {
    const warehouseSelect = document.getElementById('warehouseSelect');
    const warehouseItemsContainer = document.getElementById('warehouseItemsContainer');
    
    fetch(`{% url "warehouses_by_city_json" 0 %}`.replace('0', cityId))
        .then(response => response.json())
        .then(data => {
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            warehouseSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>';
            data.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                warehouseSelect.appendChild(option);
            });
            warehouseSelect.disabled = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤
            warehouseItemsContainer.innerHTML = '';
            data.forEach(warehouse => {
                const warehouseItem = document.createElement('div');
                warehouseItem.className = 'warehouse-item';
                warehouseItem.setAttribute('data-warehouse-id', warehouse.id);
                warehouseItem.innerHTML = `
                    <div class="warehouse-name">${warehouse.name}</div>
                    <div class="warehouse-address">${warehouse.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</div>
                `;
                
                warehouseItem.addEventListener('click', function() {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    document.querySelectorAll('.warehouse-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç
                    this.classList.add('selected');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
                    warehouseSelect.value = warehouse.id;
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Å–∫–ª–∞–¥–∞
                    loadWarehouseDetails(warehouse.id);
                });
                
                warehouseItemsContainer.appendChild(warehouseItem);
            });
            
            document.getElementById('warehouseList').style.display = 'block';
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–æ–≤:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤', 'error');
        });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Å–∫–ª–∞–¥–∞
function loadWarehouseDetails(warehouseId) {
    fetch(`{% url "warehouse_details_json" 0 %}`.replace('0', warehouseId))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å–∫–ª–∞–¥–∞:', data.error);
                return;
            }
            
            document.getElementById('warehouseName').textContent = data.name;
            document.getElementById('warehouseAddress').textContent = data.address;
            document.getElementById('warehousePhone').textContent = data.phone;
            document.getElementById('warehouseEmail').textContent = data.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('warehouseHours').textContent = data.working_hours;
            document.getElementById('warehouseArea').textContent = data.available_area;
            
            document.getElementById('warehouseDetails').style.display = 'block';
            
            // –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ê–î–†–ï–°–ê
            if (data.address && data.address !== '-') {
                document.getElementById('addressInput').value = data.address;
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Å–∫–ª–∞–¥–∞:', error);
        });
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ù–õ–ê–ô–ù-–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ====================

function initInlineEditing() {
    const editableCells = document.querySelectorAll('.editable-cell');
    
    editableCells.forEach(cell => {
        cell.addEventListener('click', function(e) {
            // –ï—Å–ª–∏ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –≤—ã—Ö–æ–¥–∏–º
            if (this.classList.contains('editing')) return;
            
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–º–µ–Ω—ã
            if (e.target.classList.contains('save-btn') || e.target.classList.contains('cancel-btn')) return;
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ç—É—Å –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ badge
            if (e.target.classList.contains('status-badge-editable')) {
                startEditing(this);
                return;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —è—á–µ–π–∫–∞ –∞–¥—Ä–µ—Å–∞ –∑–∞–±–æ—Ä–∞ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const field = this.getAttribute('data-field');
            if (field === 'pickup_address') {
                openAddressModal(this, field);
                return;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —è—á–µ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            if (this.classList.contains('editable-time-range')) {
                startTimeRangeEditing(this);
                return;
            }
            
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —è—á–µ–µ–∫ - –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫
            if (e.detail === 2) {
                startEditing(this);
            }
        });
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
function loadOperatorsList() {
    const csrfToken = getCookie('csrftoken');
    
    fetch('{% url "get_operators" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        operatorsList = data;
        console.log('–û–ø–µ—Ä–∞—Ç–æ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', operatorsList.length);
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤:', error);
        // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
        operatorsList = [
            {id: '', name: '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}
        ];
    });
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –î–ò–ê–ü–ê–ó–û–ù–ê –í–†–ï–ú–ï–ù–ò ====================

function startTimeRangeEditing(cell) {
    // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–µ
    if (editingCell && editingCell !== cell) {
        if (editingCell.classList.contains('editable-time-range')) {
            saveTimeRangeCell(editingCell.querySelector('.save-btn'));
        } else {
            saveCell(editingCell.querySelector('.save-btn'));
        }
    }
    
    const originalFrom = cell.getAttribute('data-original-from') || '';
    const originalTo = cell.getAttribute('data-original-to') || '';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    cell.setAttribute('data-original-content', cell.innerHTML);
    cell.classList.add('editing');
    editingCell = cell;
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–≤—É—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
    const container = document.createElement('div');
    container.className = 'time-range-container';
    
    // –ü–æ–ª–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ "–æ—Ç"
    const fromWrapper = document.createElement('div');
    fromWrapper.className = 'time-input-wrapper';
    const fromInput = document.createElement('input');
    fromInput.type = 'time';
    fromInput.className = 'editable-time';
    fromInput.value = originalFrom;
    fromInput.placeholder = '00:00';
    fromWrapper.appendChild(fromInput);
    
    // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    const separator = document.createElement('div');
    separator.className = 'time-separator';
    separator.textContent = '‚Äî';
    
    // –ü–æ–ª–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ "–¥–æ"
    const toWrapper = document.createElement('div');
    toWrapper.className = 'time-input-wrapper';
    const toInput = document.createElement('input');
    toInput.type = 'time';
    toInput.className = 'editable-time';
    toInput.value = originalTo;
    toInput.placeholder = '23:59';
    toWrapper.appendChild(toInput);
    
    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    container.appendChild(fromWrapper);
    container.appendChild(separator);
    container.appendChild(toWrapper);
    
    // –û—á–∏—â–∞–µ–º —è—á–µ–π–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    cell.innerHTML = '';
    cell.appendChild(container);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ
    fromInput.focus();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ–ª—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
    cell._fromInput = fromInput;
    cell._toInput = toInput;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –∏ Escape
    fromInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveTimeRangeCell(cell);
        } else if (e.key === 'Escape') {
            cancelTimeRangeEditing(cell);
        }
    });
    
    toInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveTimeRangeCell(cell);
        } else if (e.key === 'Escape') {
            cancelTimeRangeEditing(cell);
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
    fromInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (!cell.contains(document.activeElement)) {
                saveTimeRangeCell(cell);
            }
        }, 100);
    });
    
    toInput.addEventListener('blur', function() {
        setTimeout(() => {
            if (!cell.contains(document.activeElement)) {
                saveTimeRangeCell(cell);
            }
        }, 100);
    });
}

function saveTimeRangeCell(cellElement) {
    // –ï—Å–ª–∏ cellElement - —ç—Ç–æ –∫–Ω–æ–ø–∫–∞, –Ω–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —è—á–µ–π–∫—É
    let cell = cellElement;
    if (cellElement.tagName === 'BUTTON') {
        cell = cellElement.parentElement;
    }
    
    const fromValue = cell._fromInput ? cell._fromInput.value : '';
    const toValue = cell._toInput ? cell._toInput.value : '';
    const orderId = cell.closest('tr').getAttribute('data-order-id');
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –≤—Ä–µ–º—è, —Å—á–∏—Ç–∞–µ–º –µ–≥–æ –≤—Ä–µ–º–µ–Ω–µ–º "–æ—Ç"
    if (fromValue && !toValue) {
        showNotification('–£–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–µ—á–Ω–æ–µ –≤—Ä–µ–º—è –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –æ–±–∞ –ø–æ–ª—è –ø—É—Å—Ç—ã–º–∏', 'warning');
        return;
    }
    
    // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è "–¥–æ", –Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤—Ä–µ–º—è "–æ—Ç" - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    if (!fromValue && toValue) {
        showNotification('–£–∫–∞–∂–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è', 'warning');
        return;
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è: –≤—Ä–µ–º—è "–¥–æ" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ "–æ—Ç"
    if (fromValue && toValue) {
        if (fromValue >= toValue) {
            showNotification('–í—Ä–µ–º—è "–¥–æ" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ "–æ—Ç"', 'error');
            return;
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    saveTimeRangeToServer(orderId, fromValue, toValue, cell);
}

function saveTimeRangeToServer(orderId, fromValue, toValue, cell) {
    const url = `{% url 'pickup_order_update_field' 0 %}`.replace('0', orderId);
    const csrfToken = getCookie('csrftoken');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    cell.classList.add('loading');
    
    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è "–æ—Ç"
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: 'pickup_time_from',
            value: fromValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è "–¥–æ"
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    field: 'pickup_time_to',
                    value: toValue
                })
            });
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏');
        }
    })
    .then(response => response.json())
    .then(data => {
        cell.classList.remove('loading');
        
        if (data.success) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ
            updateTimeRangeCellDisplay(cell, fromValue, toValue);
            
            showNotification('–í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            editingCell = null;
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            cancelTimeRangeEditing(cell);
        }
    })
    .catch(error => {
        cell.classList.remove('loading');
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, 'error');
        cancelTimeRangeEditing(cell);
    });
}

function updateTimeRangeCellDisplay(cell, fromValue, toValue) {
    cell.classList.remove('editing');
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    let displayValue = '-';
    if (fromValue && toValue) {
        displayValue = `${fromValue}-${toValue}`;
    } else if (fromValue) {
        displayValue = `${fromValue}`;
    } else if (toValue) {
        displayValue = `${toValue}`;
    }
    
    cell.innerHTML = `
        ${displayValue}
        <button class="save-btn" onclick="saveTimeRangeCell(this)">‚úì</button>
        <button class="cancel-btn" onclick="cancelTimeRangeEditing(this.parentElement)">‚úó</button>
    `;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º data-–∞—Ç—Ä–∏–±—É—Ç—ã
    cell.setAttribute('data-original-from', fromValue || '');
    cell.setAttribute('data-original-to', toValue || '');
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
    delete cell._fromInput;
    delete cell._toInput;
}

function cancelTimeRangeEditing(cell) {
    const originalContent = cell.getAttribute('data-original-content');
    if (originalContent) {
        cell.innerHTML = originalContent;
    }
    cell.classList.remove('editing');
    editingCell = null;
    
    // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
    delete cell._fromInput;
    delete cell._toInput;
}

// ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–´–ß–ù–û–ì–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ====================

function startEditing(cell) {
    // –ï—Å–ª–∏ —É–∂–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–µ
    if (editingCell && editingCell !== cell) {
        if (editingCell.classList.contains('editable-time-range')) {
            saveTimeRangeCell(editingCell.querySelector('.save-btn'));
        } else {
            saveCell(editingCell.querySelector('.save-btn'));
        }
    }
    
    const field = cell.getAttribute('data-field');
    const originalValue = cell.getAttribute('data-original') || '';
    const type = cell.getAttribute('data-type') || 'text';
    const isStatusCell = field === 'status';
    const isOperatorCell = field === 'operator';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    cell.setAttribute('data-original-content', cell.innerHTML);
    cell.classList.add('editing');
    editingCell = cell;
    
    let inputElement;
    
    if (type === 'select' || isStatusCell || isOperatorCell) {
        inputElement = document.createElement('select');
        inputElement.className = 'editable-select';
        
        // –û–ø—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
        let options = [];
        if (field === 'status') {
            options = [
                {value: 'ready', text: '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ'},
                {value: 'payment', text: '–ù–∞ –æ–ø–ª–∞—Ç–µ'}
            ];
        } else if (field === 'operator') {
            // –û–ø—Ü–∏–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
            options = [
                {value: '', text: '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}
            ];
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞
            operatorsList.forEach(operator => {
                options.push({
                    value: operator.id,
                    text: operator.full_name || operator.username
                });
            });
        } else {
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–µ–ª–µ–∫—Ç–æ–≤
            options = [{value: originalValue, text: originalValue}];
        }
        
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            if (opt.value.toString() === originalValue.toString()) {
                option.selected = true;
            }
            inputElement.appendChild(option);
        });
    } else if (type === 'date') {
        inputElement = document.createElement('input');
        inputElement.type = 'date';
        inputElement.className = 'editable-date';
        inputElement.value = originalValue;
    } else if (type === 'number') {
        inputElement = document.createElement('input');
        inputElement.type = 'number';
        inputElement.className = 'editable-input';
        inputElement.value = originalValue;
        inputElement.min = field === 'quantity' ? '1' : '0';
        inputElement.step = '1';
    } else {
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.className = 'editable-input';
        inputElement.value = originalValue;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è input
    const inputContainer = document.createElement('div');
    inputContainer.className = 'inline-input-container';
    inputContainer.appendChild(inputElement);
    
    // –û—á–∏—â–∞–µ–º —è—á–µ–π–∫—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º input
    cell.innerHTML = '';
    cell.appendChild(inputContainer);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    inputElement.focus();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –∏ Escape
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveCell(cell);
        } else if (e.key === 'Escape') {
            cancelEditing(cell);
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
    inputElement.addEventListener('blur', function() {
        setTimeout(() => {
            if (!cell.contains(document.activeElement)) {
                saveCell(cell);
            }
        }, 100);
    });
}

function startEditStatus(statusBadge) {
    const cell = statusBadge.closest('.editable-cell');
    startEditing(cell);
}

function saveCell(cell) {
    // –ï—Å–ª–∏ cell - —ç—Ç–æ –∫–Ω–æ–ø–∫–∞, –Ω–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é —è—á–µ–π–∫—É
    if (cell.tagName === 'BUTTON') {
        cell = cell.parentElement;
    }
    
    const inputElement = cell.querySelector('input, select');
    if (!inputElement) return;
    
    const newValue = inputElement.value;
    const field = cell.getAttribute('data-field');
    const orderId = cell.closest('tr').getAttribute('data-order-id');
    const type = cell.getAttribute('data-type') || 'text';
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (field === 'quantity' && (!newValue || parseInt(newValue) < 1)) {
        showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1', 'error');
        return;
    }
    
    // –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: –µ—Å–ª–∏ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º null
    let valueToSend = newValue;
    if (field === 'operator' && newValue === '') {
        valueToSend = null;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    saveToServer(orderId, field, valueToSend, cell, type);
}

function saveToServer(orderId, field, value, cell, type) {
    const url = `{% url 'pickup_order_update_field' 0 %}`.replace('0', orderId);
    const csrfToken = getCookie('csrftoken');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    cell.classList.add('loading');
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: value
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        cell.classList.remove('loading');
        
        if (data.success) {
            let displayValue = data.display_value;
            
            // –î–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ —Å–ø–∏—Å–∫–∞
            if (field === 'operator') {
                const operator = operatorsList.find(op => op.id.toString() === value);
                displayValue = operator ? operator.full_name || operator.username : '';
            }
            
            updateCellDisplay(cell, field, value, displayValue, type);
            showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            editingCell = null;
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            cancelEditing(cell);
        }
    })
    .catch(error => {
        cell.classList.remove('loading');
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, 'error');
        cancelEditing(cell);
    });
}

function updateCellDisplay(cell, field, value, displayValue, type) {
    cell.classList.remove('editing');
    
    if (field === 'status') {
        // –û–±–Ω–æ–≤–ª—è–µ–º badge —Å—Ç–∞—Ç—É—Å–∞
        const statusClass = `status-${value}`;
        
        cell.innerHTML = `
            <span class="status-badge-editable ${statusClass}" onclick="startEditStatus(this)">
                ${displayValue || value}
            </span>
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'operator') {
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        let operatorName = '-';
        if (value && displayValue) {
            operatorName = displayValue;
        } else if (value) {
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ ID
            const operator = operatorsList.find(op => op.id.toString() === value.toString());
            operatorName = operator ? (operator.full_name || operator.username) : `–û–ø–µ—Ä–∞—Ç–æ—Ä #${value}`;
        }
        
        cell.innerHTML = `
            <span class="operator-name">${operatorName}</span>
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value || '');
    } else if (field === 'pickup_date' || field === 'desired_delivery_date') {
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let displayText = '-';
        if (value) {
            const date = new Date(value);
            if (!isNaN(date)) {
                displayText = date.toLocaleDateString('ru-RU');
            }
        }
        cell.innerHTML = `
            ${displayText}
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'invoice_number') {
        if (!value || value.trim() === '') {
            cell.innerHTML = `
                <span class="text-muted">-</span>
                <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
            `;
        } else {
            cell.innerHTML = `
                <span class="invoice-number">${value}</span>
                <button class="save-btn" onclick="saveCell(this)">‚úì</button>
                <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
            `;
        }
        cell.setAttribute('data-original', value);
    } else if (field === 'pickup_address') {
        const addressText = value || '';
        const displayText = addressText.length > 30 ? addressText.substring(0, 30) + '...' : addressText;
        
        let badgeHtml = '';
        const existingBadge = cell.querySelector('.badge.bg-info');
        if (existingBadge) {
            badgeHtml = existingBadge.outerHTML;
        }
        
        cell.innerHTML = `
            ${displayText}
            ${badgeHtml}
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
        cell.setAttribute('data-full-address', value);
    } else if (field === 'contact_person' || field === 'client_name') {
        cell.innerHTML = `
            ${value.length > 20 ? value.substring(0, 20) + '...' : value}
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'quantity') {
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
    } else {
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">‚úì</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">‚úó</button>
        `;
        cell.setAttribute('data-original', value);
    }
}

function cancelEditing(cell) {
    const originalContent = cell.getAttribute('data-original-content');
    if (originalContent) {
        cell.innerHTML = originalContent;
    }
    cell.classList.remove('editing');
    editingCell = null;
}

// ==================== –û–ë–©–ò–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================

function showNotification(message, type) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const oldNotifications = document.querySelectorAll('.notification-alert');
    oldNotifications.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-alert`;
    alert.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            ${type === 'success' ? 
                '<i class="bi bi-check-circle-fill me-2 fs-5"></i>' : 
                '<i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>'
            }
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ body
    document.body.appendChild(alert);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        if (alert.parentNode) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ onclick
window.saveCell = saveCell;
window.cancelEditing = cancelEditing;
window.startEditStatus = startEditStatus;
window.openAddressModal = openAddressModal;
window.saveTimeRangeCell = saveTimeRangeCell;
window.cancelTimeRangeEditing = cancelTimeRangeEditing;
</script>

{% if is_operator %}
</div>
{% endif %}
{% endblock %}