{% extends 'base.html' %}

{% block content %}
{% if is_operator %}
<div class="operator-view">
{% endif %}

<h2 class="mb-4">Заявки на доставку</h2>

{% if is_operator %}
<div class="alert alert-info">
    <strong>Режим оператора:</strong> Вы видите только свои заявки. 
    Всего заявок: {{ orders.count }}
</div>
{% endif %}

{% if is_logistic %}
<div class="alert alert-warning">
    <strong>Режим логиста:</strong> Вы видите все заявки. 
    Используйте фильтры для поиска по городам.
</div>
{% endif %}

<style>
    /* Существующие стили остаются без изменений */
    .sortable-header {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px !important;
        transition: background-color 0.2s ease;
    }
    
    .sortable-header:hover {
        background-color: #444 !important;
    }
    
    .sort-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 12px;
        opacity: 0.7;
        color: #ffffff;
    }
    
    .sortable-header.sorted-asc .sort-icon::after {
        content: "↑";
        color: #28a745;
        opacity: 1;
        font-weight: bold;
    }
    
    .sortable-header.sorted-desc .sort-icon::after {
        content: "↓";
        color: #dc3545;
        opacity: 1;
        font-weight: bold;
    }
    
    .sortable-header:hover .sort-icon {
        opacity: 0.9;
    }
    
    .editable-cell {
        cursor: pointer;
        position: relative;
        transition: background-color 0.2s;
        padding: 8px !important;
        min-height: 40px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: normal !important;
        color: #212529 !important;
    }

    .editable-cell:hover {
        background-color: rgba(13, 110, 253, 0.1) !important;
        outline: 2px solid rgba(13, 110, 253, 0.3);
        outline-offset: -2px;
    }

    .editable-cell.editing {
        background-color: rgba(255, 255, 204, 0.3) !important;
        padding: 0 !important;
    }

    .editable-input {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-select {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-date {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .editable-textarea {
        width: 100%;
        padding: 6px 10px;
        border: 2px solid #0d6efd;
        border-radius: 4px;
        font-size: 15px !important;
        background-color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        resize: vertical;
        min-height: 60px;
    }

    .save-btn {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        background: #198754;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 10;
        transition: all 0.2s;
    }

    .save-btn:hover {
        background: #157347;
    }

    .editing .save-btn {
        display: block;
    }

    .cancel-btn {
        position: absolute;
        right: 40px;
        top: 50%;
        transform: translateY(-50%);
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 3px;
        padding: 2px 8px;
        font-size: 12px;
        cursor: pointer;
        display: none;
        z-index: 10;
        transition: all 0.2s;
    }

    .cancel-btn:hover {
        background: #c82333;
    }

    .editing .cancel-btn {
        display: block;
    }

    .status-badge-editable {
        cursor: pointer;
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 15px !important;
        font-weight: normal !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        transition: all 0.2s;
        background-color: transparent !important;
    }

    .status-badge-editable:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .inline-input-container {
        position: relative;
        padding: 6px 10px;
    }

    .driver-info-container {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        min-width: 300px;
        max-width: 400px;
    }

    .table th {
        white-space: nowrap;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: 600 !important;
        color: #fff !important;
    }

    .table td {
        vertical-align: middle;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: normal !important;
        color: #212529 !important;
    }

    .weight-volume-cell {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: normal !important;
    }

    .table td strong {
        font-weight: normal !important;
    }

    .status-submitted { 
        color: #6c757d !important; 
        font-weight: 600 !important;
    }
    
    .status-driver_assigned { 
        color: #0d6efd !important; 
        font-weight: 600 !important;
    }
    
    .status-shipped { 
        color: #198754 !important; 
        font-weight: 600 !important;
    }

    table code {
        color: inherit !important;
        background-color: transparent !important;
        font-family: inherit !important;
        font-size: inherit !important;
        padding: 0 !important;
        border: none !important;
    }

    .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .table th,
    .table td {
        padding: 12px 10px !important;
    }

    /* ЕДИНЫЕ СТИЛИ КНОПОК (ОБНОВЛЕННЫЕ) */
    .btn-group-sm .btn {
        font-size: 13px !important;
        padding: 4px 8px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        border-radius: 4px !important;
        border: 1px solid #dee2e6 !important;
        background-color: transparent !important;
        color: #495057 !important;
        transition: all 0.2s ease !important;
    }

    .btn-group-sm .btn:hover {
        background-color: #f8f9fa !important;
        border-color: #0d6efd !important;
        color: #0d6efd !important;
    }

    .pagination .page-link {
        font-size: 15px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .form-control, .form-select {
        font-size: 15px !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    .card-header h5, .card-header h6 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        font-size: 15px !important;
        font-weight: 600 !important;
    }

    .operator-view .editable-cell {
        cursor: default !important;
    }

    .operator-view .editable-cell:hover {
        background-color: inherit !important;
        outline: none !important;
    }

    .operator-view .status-badge-editable {
        cursor: default !important;
        pointer-events: none !important;
    }

    .operator-view .status-badge-editable:hover {
        transform: none !important;
        box-shadow: none !important;
    }

    .operator-view .save-btn,
    .operator-view .cancel-btn {
        display: none !important;
    }

    /* Стили для адреса в таблице */
    .address-cell {
        max-width: 300px;
        position: relative;
    }

    .address-text {
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }

    .address-text:hover::after {
        content: attr(title);
        position: absolute;
        left: 0;
        top: 100%;
        background: #333;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        white-space: normal;
        width: 300px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    /* Общие стили для модального окна адреса */
    #addressModal .card {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    #addressModal .card-body p {
        margin-bottom: 0.5rem;
        font-size: 14px;
    }

    #addressModal .card-body strong {
        color: #495057;
        min-width: 120px;
        display: inline-block;
    }

    #warehouseDetails {
        transition: all 0.3s ease;
    }

    .warehouse-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-top: 10px;
    }

    .warehouse-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .warehouse-item:hover {
        background-color: #f8f9fa;
    }

    .warehouse-item.selected {
        background-color: #e7f1ff;
        border-left: 3px solid #0d6efd;
    }

    .warehouse-name {
        font-weight: 600;
        margin-bottom: 2px;
    }

    .warehouse-address {
        color: #666;
        font-size: 13px;
        margin-bottom: 2px;
        white-space: normal;
        word-break: break-word;
    }

    .warehouse-city {
        color: #888;
        font-size: 12px;
    }

    /* Стили для текстового поля адреса в модальном окне */
    #addressInput {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 15px;
        line-height: 1.5;
    }

    /* Стили для массового редактирования */
    #bulkEditBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    #bulkEditModal .modal-content {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
    }

    #bulkEditModal .form-label {
        font-weight: 600;
        font-size: 15px !important;
    }

    #bulkEditModal .form-control,
    #bulkEditModal .form-select {
        font-size: 15px !important;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .table th,
        .table td {
            padding: 8px 6px !important;
            font-size: 15px !important;
        }
        
        .editable-cell {
            font-size: 15px !important;
        }
        
        .status-badge-editable {
            font-size: 14px !important;
        }
        
        .btn-group-sm .btn {
            font-size: 13px !important;
            padding: 3px 6px !important;
        }
        
        .sort-icon {
            right: 4px;
            font-size: 10px;
        }
        
        .address-text:hover::after {
            display: none;
        }
        
        #addressModal .modal-dialog {
            margin: 0.5rem;
        }
        
        #bulkEditModal .modal-dialog {
            margin: 0.5rem;
        }
        
        .warehouse-list {
            max-height: 200px;
        }
    }

    /* ЕДИНЫЕ СТИЛИ ДЛЯ ВСЕХ КНОПОК (СИНЯЯ СХЕМА) */
    .btn {
        border-radius: 4px !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        border: 1px solid #dee2e6 !important;
        background-color: transparent !important;
        color: #495057 !important;
    }

    .btn:hover {
        background-color: #f8f9fa !important;
        border-color: #0d6efd !important;
        color: #0d6efd !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    }

    .btn:disabled, .btn.disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
        background-color: #f8f9fa !important;
        border-color: #dee2e6 !important;
        color: #6c757d !important;
    }

    .btn:disabled:hover, .btn.disabled:hover {
        background-color: #f8f9fa !important;
        border-color: #dee2e6 !important;
        color: #6c757d !important;
        transform: none !important;
        box-shadow: none !important;
    }

    /* Специфичные стили для кнопок действий в таблице */
    .table .btn-group-sm .btn {
        margin: 0 2px;
    }

    /* Стили для кнопки "Добавить" (единственная с заливкой) */
    .btn-success {
        background-color: #198754 !important;
        border-color: #198754 !important;
        color: white !important;
    }

    .btn-success:hover {
        background-color: #157347 !important;
        border-color: #146c43 !important;
        color: white !important;
    }

    /* Стили для кнопок в модальных окнах */
    .modal-footer .btn-primary {
        background-color: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
    }

    .modal-footer .btn-primary:hover {
        background-color: #0b5ed7 !important;
        border-color: #0a58ca !important;
        color: white !important;
    }

    .modal-footer .btn-secondary {
        background-color: transparent !important;
        border-color: #6c757d !important;
        color: #6c757d !important;
    }

    .modal-footer .btn-secondary:hover {
        background-color: #6c757d !important;
        color: white !important;
    }
</style>

<!-- Форма фильтрации -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Фильтры</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-3">
                <label class="form-label">Дата от</label>
                <input type="date" name="date__gte" class="form-control" value="{{ request.GET.date__gte }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Дата до</label>
                <input type="date" name="date__lte" class="form-control" value="{{ request.GET.date__lte }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Статус</label>
                <select name="status" class="form-select">
                    <option value="">Все</option>
                    <option value="submitted" {% if request.GET.status == 'submitted' %}selected{% endif %}>Подана</option>
                    <option value="driver_assigned" {% if request.GET.status == 'driver_assigned' %}selected{% endif %}>Водитель назначен</option>
                    <option value="shipped" {% if request.GET.status == 'shipped' %}selected{% endif %}>Отправлено</option>
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn w-100">Фильтровать</button>
                <a href="{% url 'delivery_order_list' %}" class="btn ms-2">Сбросить</a>
            </div>
        </form>
    </div>
</div>

<!-- Скрытая форма для списка PDF -->
<form id="listPdfForm" method="get" action="{% url 'delivery_orders_list_pdf' %}" style="display: none;">
</form>

<!-- блок массовых действий с кнопкой добавления -->
<div class="card mb-3">
    <div class="card-header bg-light">
        <h6 class="mb-0">Массовые действия</h6>
    </div>
    <div class="card-body">
        <form id="bulkActionsForm" method="get" action="{% url 'delivery_orders_bulk_pdf' %}">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="button" class="btn btn-sm" id="selectAllBtn">
                        <i class="bi bi-check-square"></i> Выбрать все
                    </button>
                    <button type="button" class="btn btn-sm ms-2" id="deselectAllBtn">
                        <i class="bi bi-square"></i> Снять выбор
                    </button>
                    <span class="ms-3 text-muted" id="selectedCount">Выбрано: 0</span>
                </div>
                <div>
                    <button type="button" class="btn me-2" id="exportListPdfBtn" disabled>
                        <i class="bi bi-file-text"></i> Список в PDF
                    </button>
                    <button type="submit" class="btn" id="exportPdfBtn" disabled>
                        <i class="bi bi-file-pdf"></i> Отдельные PDF (ZIP)
                    </button>
                    {% if not is_operator %}
                    <button type="button" class="btn me-2" id="bulkEditBtn" disabled>
                        <i class="bi bi-pencil-square"></i> Массовое редактирование
                    </button>
                    {% endif %}
                    <a href="{% url 'delivery_order_create' %}" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Добавить новую заявку
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Таблица с чекбоксами и инлайн-редактированием -->
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead class="table-dark">
            <tr>
                <th style="width: 40px;">
                    <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                </th>
                <th class="sortable-header {% if sort == 'date' %}sorted-{{ order }}{% endif %}" 
                    data-sort="date">
                    Дата
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'pickup_address' %}sorted-{{ order }}{% endif %}" 
                    data-sort="pickup_address">
                    Адрес отправки
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'delivery_address' %}sorted-{{ order }}{% endif %}" 
                    data-sort="delivery_address">
                    Адрес доставки
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'quantity' %}sorted-{{ order }}{% endif %}" 
                    data-sort="quantity">
                    Места
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'weight' %}sorted-{{ order }}{% endif %}" 
                    data-sort="weight">
                    Вес/Объем
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'status' %}sorted-{{ order }}{% endif %}" 
                    data-sort="status">
                    Статус
                    <span class="sort-icon"></span>
                </th>
                <th class="sortable-header {% if sort == 'driver_name' %}sorted-{{ order }}{% endif %}" 
                    data-sort="driver_name">
                    Водитель
                    <span class="sort-icon"></span>
                </th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr data-order-id="{{ order.id }}">
                <td>
                    <input type="checkbox" name="order_ids" value="{{ order.id }}" 
                           class="form-check-input order-checkbox">
                </td>
                <td class="editable-cell" data-field="date" data-original="{{ order.date|date:'Y-m-d' }}" data-type="date">
                    {{ order.date|date:"d.m.Y" }}
                    <button class="save-btn" onclick="saveCell(this)">✓</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                </td>
                <td class="editable-cell address-cell" 
                    data-field="pickup_address" 
                    data-original="{% firstof order.pickup_warehouse.address order.pickup_address '' %}">
                    <div class="address-text" title="{% firstof order.pickup_warehouse.address order.pickup_address 'Не указан' %}">
                        {% if order.pickup_warehouse %}
                            {{ order.pickup_warehouse.address|truncatechars:30 }}
                        {% else %}
                            {{ order.pickup_address|default:"Не указан"|truncatechars:30 }}
                        {% endif %}
                    </div>
                    <button class="save-btn" onclick="saveCell(this)">✓</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                </td>
                <td class="editable-cell address-cell" 
                    data-field="delivery_address" 
                    data-original="{% firstof order.delivery_warehouse.address order.delivery_address '' %}">
                    <div class="address-text" title="{% firstof order.delivery_warehouse.address order.delivery_address 'Не указан' %}">
                        {% if order.delivery_warehouse %}
                            {{ order.delivery_warehouse.address|truncatechars:30 }}
                        {% else %}
                            {{ order.delivery_address|default:"Не указан"|truncatechars:30 }}
                        {% endif %}
                    </div>
                    <button class="save-btn" onclick="saveCell(this)">✓</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                </td>
                <td class="editable-cell" data-field="quantity" data-original="{{ order.quantity }}" data-type="number">
                    {{ order.quantity }}
                    <button class="save-btn" onclick="saveCell(this)">✓</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                </td>
                <td>
                    <div class="d-flex align-items-center gap-2 weight-volume-cell">
                        <span class="editable-cell" data-field="weight" data-original="{{ order.weight }}" data-type="number" style="flex: 1;">
                            {{ order.weight }}
                            <button class="save-btn" onclick="saveCell(this)">✓</button>
                            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                        </span>
                        <span>кг /</span>
                        <span class="editable-cell" data-field="volume" data-original="{{ order.volume }}" data-type="number" style="flex: 1;">
                            {{ order.volume }}
                            <button class="save-btn" onclick="saveCell(this)">✓</button>
                            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                        </span>
                        <span>м³</span>
                    </div>
                </td>
                <td class="editable-cell" data-field="status" data-original="{{ order.status }}" data-type="select">
                    <span class="status-badge-editable status-{{ order.status }}" onclick="startEditStatus(this)">
                        {{ order.get_status_display }}
                    </span>
                    <button class="save-btn" onclick="saveCell(this)">✓</button>
                    <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                </td>
                <td>
                    <div class="driver-info-container">
                        <span class="editable-cell" data-field="driver_name" data-original="{{ order.driver_name|default:'' }}">
                            {% if order.driver_name %}
                                {{ order.driver_name }}
                            {% else %}
                                <span class="text-muted">Не назначен</span>
                            {% endif %}
                            <button class="save-btn" onclick="saveCell(this)">✓</button>
                            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                        </span>
                        {% if order.driver_phone %}
                        <small class="editable-cell" data-field="driver_phone" data-original="{{ order.driver_phone }}" style="color: #666; font-size: 15px;">
                            {{ order.driver_phone }}
                            <button class="save-btn" onclick="saveCell(this)">✓</button>
                            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
                        </small>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'delivery_order_detail' order.pk %}" 
                           class="btn">Просмотр</a>
                        <a href="{% url 'delivery_order_update' order.pk %}" 
                           class="btn">Назначить</a>
                        <a href="{% url 'delivery_order_pdf' order.pk %}" 
                           class="btn">
                            <i class="bi bi-file-pdf"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="text-center py-4" style="font-size: 15px;">Нет заявок по заданным фильтрам</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Пагинация -->
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Назад</a>
        </li>
        {% endif %}
        
        <li class="page-item disabled">
            <span class="page-link">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Вперед</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Модальное окно для редактирования адреса -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addressModalLabel">Редактирование адреса</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Текстовое поле для адреса -->
        <div class="mb-3">
          <label for="addressInput" class="form-label">Адрес</label>
          <textarea 
            class="form-control" 
            id="addressInput" 
            rows="3" 
            placeholder="Введите адрес..."
          ></textarea>
          <div class="form-text">Можно ввести вручную или выбрать склад для автоматической подстановки адреса</div>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="citySelect" class="form-label">Город</label>
              <select class="form-select" id="citySelect">
                <option value="">Выберите город</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="warehouseSelect" class="form-label">Склад</label>
              <select class="form-select" id="warehouseSelect" disabled>
                <option value="">Сначала выберите город</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Список складов с адресами -->
        <div id="warehouseList" class="mt-3" style="display: none;">
          <h6 class="mb-2">Список складов в выбранном городе:</h6>
          <div class="warehouse-list" id="warehouseItemsContainer">
            <!-- Склады будут загружены здесь -->
          </div>
        </div>
        
        <div id="warehouseDetails" class="mt-3" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Выбранный склад</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Название:</strong> <span id="warehouseName">-</span></p>
                  <p><strong>Адрес:</strong> <span id="warehouseAddress">-</span></p>
                  <p><strong>Телефон:</strong> <span id="warehousePhone">-</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Email:</strong> <span id="warehouseEmail">-</span></p>
                  <p><strong>График работы:</strong> <span id="warehouseHours">-</span></p>
                  <p><strong>Доступная площадь:</strong> <span id="warehouseArea">-</span> м²</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveAddressBtn">Сохранить адрес</button>
      </div>
    </div>
  </div>
</div>

<!-- Модальное окно для массового редактирования -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-labelledby="bulkEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bulkEditModalLabel">Массовое редактирование</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="bulkEditForm">
          <div class="mb-3">
            <label for="bulkEditField" class="form-label">Поле для редактирования</label>
            <select class="form-select" id="bulkEditField">
              <option value="">Выберите поле</option>
              <option value="status">Статус</option>
              <option value="driver_name">Имя водителя</option>
              <option value="driver_phone">Телефон водителя</option>
              <option value="vehicle">Транспортное средство</option>
              <option value="date">Дата доставки</option>
              <option value="fulfillment">Фулфилмент оператор</option>
              <option value="quantity">Количество мест</option>
              <option value="weight">Вес (кг)</option>
              <option value="volume">Объем (м³)</option>
            </select>
          </div>
          <div class="mb-3" id="bulkEditValueContainer">
            <!-- Здесь будет поле для ввода значения в зависимости от выбранного поля -->
          </div>
          <div class="alert alert-info">
            <small>
              <i class="bi bi-info-circle"></i> Будет обновлено: <span id="selectedOrdersCount">0</span> заявок
            </small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="bulkEditSaveBtn">Сохранить изменения</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript для инлайн-редактирования и модального окна складов -->
<script>
// Глобальные переменные для хранения состояния
let editingCell = null;
let operatorsList = [];
let currentAddressCell = null;
let currentAddressField = null; // 'pickup_address' или 'delivery_address'
let bulkEditModal = null;

// Загружаем список операторов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем, является ли пользователь оператором
    const isOperator = {{ is_operator|yesno:"true,false" }};
    
    if (!isOperator) {
        // Только для не-операторов (логистов и админов) инициализируем редактирование
        initInlineEditing();
        initAddressModal();
        loadOperatorsList();
    }
    
    // Инициализация массового выбора
    initBulkActions();
});

// ==================== ИНИЦИАЛИЗАЦИЯ МОДАЛЬНОГО ОКНА АДРЕСА ====================

function initAddressModal() {
    const modal = document.getElementById('addressModal');
    
    // Очистка при закрытии
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('citySelect').value = '';
        document.getElementById('warehouseSelect').value = '';
        document.getElementById('warehouseSelect').disabled = true;
        document.getElementById('warehouseList').style.display = 'none';
        document.getElementById('warehouseDetails').style.display = 'none';
        document.getElementById('addressInput').value = '';
        document.getElementById('warehouseItemsContainer').innerHTML = '';
        currentAddressCell = null;
        currentAddressField = null;
    });
    
    // Загрузка данных при открытии
    modal.addEventListener('show.bs.modal', function() {
        loadCities();
    });
    
    // Обработчик выбора города
    document.getElementById('citySelect').addEventListener('change', function() {
        const cityId = this.value;
        if (cityId) {
            loadWarehousesByCity(cityId);
            document.getElementById('warehouseDetails').style.display = 'none';
        } else {
            document.getElementById('warehouseSelect').value = '';
            document.getElementById('warehouseSelect').disabled = true;
            document.getElementById('warehouseList').style.display = 'none';
            document.getElementById('warehouseDetails').style.display = 'none';
        }
    });
    
    // Обработчик выбора склада
    document.getElementById('warehouseSelect').addEventListener('change', function() {
        const warehouseId = this.value;
        if (warehouseId) {
            loadWarehouseDetails(warehouseId);
        } else {
            document.getElementById('warehouseDetails').style.display = 'none';
        }
    });
    
    // Кнопка сохранения адреса
    document.getElementById('saveAddressBtn').addEventListener('click', function() {
        saveAddressFromModal();
    });
    
    // Сохранение по Ctrl+Enter
    document.getElementById('addressInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            saveAddressFromModal();
        }
    });
}

// Открытие модального окна при клике на ячейку адреса
function openAddressModal(cell, field) {
    currentAddressCell = cell;
    currentAddressField = field;
    
    // Получаем текущий адрес из data-атрибута
    const currentAddress = cell.getAttribute('data-original') || '';
    
    // Заполняем поле адреса
    document.getElementById('addressInput').value = currentAddress;
    
    // Открываем модальное окно
    const modal = new bootstrap.Modal(document.getElementById('addressModal'));
    modal.show();
}

// Сохранение адреса из модального окна
function saveAddressFromModal() {
    if (!currentAddressCell || !currentAddressField) return;
    
    const newAddress = document.getElementById('addressInput').value.trim();
    const warehouseSelect = document.getElementById('warehouseSelect');
    const selectedWarehouseId = warehouseSelect.value;
    const selectedWarehouseText = warehouseSelect.options[warehouseSelect.selectedIndex].text;
    
    if (!newAddress) {
        showNotification('Пожалуйста, введите адрес', 'error');
        return;
    }
    
    const orderId = currentAddressCell.closest('tr').getAttribute('data-order-id');
    
    // Если выбран склад, обновляем оба поля
    if (selectedWarehouseId) {
        updateOrderWarehouseAndAddress(currentAddressCell, selectedWarehouseId, newAddress, selectedWarehouseText);
    } else {
        // Иначе обновляем только адрес
        updateOrderAddressOnly(currentAddressCell, newAddress, orderId, currentAddressField);
    }
}

// Обновление только адреса (без склада)
function updateOrderAddressOnly(cell, address, orderId, field) {
    const csrfToken = getCookie('csrftoken');
    const url = `{% url 'delivery_order_update_field' 0 %}`.replace('0', orderId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: address
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Обновляем отображение в ячейке
            updateCellDisplay(cell, field, address, data.display_value || address, 'text');
            
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
            modal.hide();
            
            showNotification('Адрес успешно обновлен', 'success');
        } else {
            throw new Error(data.error || 'Ошибка обновления адреса');
        }
    })
    .catch(error => {
        console.error('Ошибка обновления адреса:', error);
        showNotification('Ошибка обновления адреса: ' + error.message, 'error');
    });
}

// Обновление склада и адреса
function updateOrderWarehouseAndAddress(cell, warehouseId, address, warehouseText) {
    const orderId = cell.closest('tr').getAttribute('data-order-id');
    const csrfToken = getCookie('csrftoken');
    const url = `{% url 'delivery_order_update_field' 0 %}`.replace('0', orderId);
    const field = currentAddressField;
    
    // Определяем поле для склада в зависимости от типа адреса
    let warehouseField;
    if (field === 'pickup_address') {
        warehouseField = 'warehouse';
    } else if (field === 'delivery_address') {
        warehouseField = 'receiving_warehouse';
    } else {
        showNotification('Неизвестный тип адреса', 'error');
        return;
    }
    
    // Сначала обновляем склад
    updateField(orderId, warehouseField, warehouseId, url)
        .then(() => {
            // Затем обновляем адрес
            return updateField(orderId, field, address, url);
        })
        .then((data) => {
            if (data.success) {
                // Обновляем отображение в ячейке
                updateCellDisplay(cell, field, address, data.display_value || address, 'text');
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('addressModal'));
                modal.hide();
                
                showNotification('Адрес и склад успешно обновлены', 'success');
            } else {
                throw new Error(data.error || 'Ошибка обновления адреса');
            }
        })
        .catch(error => {
            console.error('Ошибка обновления склада и адреса:', error);
            showNotification('Ошибка: ' + error.message, 'error');
        });
}

// Универсальная функция обновления поля
function updateField(orderId, field, value, url) {
    const csrfToken = getCookie('csrftoken');
    
    return fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: value
        })
    })
    .then(response => response.json());
}

// Загрузка городов
function loadCities() {
    const citySelect = document.getElementById('citySelect');
    
    fetch('{% url "cities_json" %}')
        .then(response => response.json())
        .then(data => {
            citySelect.innerHTML = '<option value="">Выберите город</option>';
            data.forEach(city => {
                const option = document.createElement('option');
                option.value = city.id;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки городов:', error);
            showNotification('Ошибка загрузки списка городов', 'error');
        });
}

// Загрузка складов по городу
function loadWarehousesByCity(cityId) {
    const warehouseSelect = document.getElementById('warehouseSelect');
    const warehouseItemsContainer = document.getElementById('warehouseItemsContainer');
    
    fetch(`{% url "warehouses_by_city_json" 0 %}`.replace('0', cityId))
        .then(response => response.json())
        .then(data => {
            // Обновляем выпадающий список
            warehouseSelect.innerHTML = '<option value="">Выберите склад</option>';
            data.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                warehouseSelect.appendChild(option);
            });
            warehouseSelect.disabled = false;
            
            // Обновляем список складов
            warehouseItemsContainer.innerHTML = '';
            data.forEach(warehouse => {
                const warehouseItem = document.createElement('div');
                warehouseItem.className = 'warehouse-item';
                warehouseItem.setAttribute('data-warehouse-id', warehouse.id);
                warehouseItem.innerHTML = `
                    <div class="warehouse-name">${warehouse.name}</div>
                    <div class="warehouse-address">${warehouse.address || 'Адрес не указан'}</div>
                `;
                
                warehouseItem.addEventListener('click', function() {
                    // Снимаем выделение со всех элементов
                    document.querySelectorAll('.warehouse-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    // Выделяем текущий элемент
                    this.classList.add('selected');
                    
                    // Устанавливаем значение в выпадающем списке
                    warehouseSelect.value = warehouse.id;
                    
                    // Загружаем детали склада
                    loadWarehouseDetails(warehouse.id);
                });
                
                warehouseItemsContainer.appendChild(warehouseItem);
            });
            
            document.getElementById('warehouseList').style.display = 'block';
        })
        .catch(error => {
            console.error('Ошибка загрузки складов:', error);
            showNotification('Ошибка загрузки списка складов', 'error');
        });
}

// Загрузка деталей склада
function loadWarehouseDetails(warehouseId) {
    fetch(`{% url "warehouse_details_json" 0 %}`.replace('0', warehouseId))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Ошибка загрузки деталей склада:', data.error);
                return;
            }
            
            document.getElementById('warehouseName').textContent = data.name;
            document.getElementById('warehouseAddress').textContent = data.address;
            document.getElementById('warehousePhone').textContent = data.phone;
            document.getElementById('warehouseEmail').textContent = data.email || 'Не указан';
            document.getElementById('warehouseHours').textContent = data.working_hours;
            document.getElementById('warehouseArea').textContent = data.available_area;
            
            document.getElementById('warehouseDetails').style.display = 'block';
            
            // АВТОМАТИЧЕСКОЕ ЗАПОЛНЕНИЕ АДРЕСА
            if (data.address && data.address !== '-') {
                document.getElementById('addressInput').value = data.address;
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки деталей склада:', error);
        });
}

// ==================== ИНИЦИАЛИЗАЦИЯ ИНЛАЙН-РЕДАКТИРОВАНИЯ ====================

function initInlineEditing() {
    const editableCells = document.querySelectorAll('.editable-cell');
    
    editableCells.forEach(cell => {
        cell.addEventListener('click', function(e) {
            // Если уже в режиме редактирования, выходим
            if (this.classList.contains('editing')) return;
            
            // Если кликнули на кнопку сохранения или отмены
            if (e.target.classList.contains('save-btn') || e.target.classList.contains('cancel-btn')) return;
            
            // Если это статус и кликнули на badge
            if (e.target.classList.contains('status-badge-editable')) {
                startEditing(this);
                return;
            }
            
            // Если это ячейка адреса - открываем модальное окно
            const field = this.getAttribute('data-field');
            if (field === 'pickup_address' || field === 'delivery_address') {
                openAddressModal(this, field);
                return;
            }
            
            // Для остальных ячеек - двойной клик
            if (e.detail === 2) {
                startEditing(this);
            }
        });
    });
}

// Загрузка списка операторов
function loadOperatorsList() {
    const csrfToken = getCookie('csrftoken');
    
    fetch('{% url "get_operators" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        operatorsList = data;
        console.log('Операторы загружены:', operatorsList.length);
    })
    .catch(error => {
        console.error('Ошибка загрузки операторов:', error);
        // Запасной вариант: статический список
        operatorsList = [
            {id: '', name: 'Не назначен'}
        ];
    });
}

function startEditing(cell) {
    // Если уже редактируем другую ячейку, сохраняем ее
    if (editingCell && editingCell !== cell) {
        saveCell(editingCell.querySelector('.save-btn'));
    }
    
    const field = cell.getAttribute('data-field');
    const originalValue = cell.getAttribute('data-original') || '';
    const type = cell.getAttribute('data-type') || 'text';
    const isStatusCell = field === 'status';
    
    // Сохраняем оригинальное содержимое
    cell.setAttribute('data-original-content', cell.innerHTML);
    cell.classList.add('editing');
    editingCell = cell;
    
    let inputElement;
    
    if (type === 'select' || isStatusCell) {
        inputElement = document.createElement('select');
        inputElement.className = 'editable-select';
        
        // Опции для статусов
        let options = [];
        if (field === 'status') {
            options = [
                {value: 'submitted', text: 'Подана'},
                {value: 'driver_assigned', text: 'Водитель назначен'},
                {value: 'shipped', text: 'Отправлено'}
            ];
        } else {
            options = [{value: originalValue, text: originalValue}];
        }
        
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            if (opt.value.toString() === originalValue.toString()) {
                option.selected = true;
            }
            inputElement.appendChild(option);
        });
    } else if (type === 'date') {
        inputElement = document.createElement('input');
        inputElement.type = 'date';
        inputElement.className = 'editable-date';
        inputElement.value = originalValue;
    } else if (type === 'time') {
        inputElement = document.createElement('input');
        inputElement.type = 'time';
        inputElement.className = 'editable-input';
        inputElement.value = originalValue;
    } else if (type === 'number') {
        inputElement = document.createElement('input');
        inputElement.type = 'number';
        inputElement.className = 'editable-input';
        inputElement.value = originalValue;
        inputElement.min = field === 'quantity' ? '1' : '0';
        inputElement.step = field === 'weight' || field === 'volume' ? '0.01' : '1';
    } else {
        inputElement = document.createElement('input');
        inputElement.type = 'text';
        inputElement.className = 'editable-input';
        inputElement.value = originalValue;
    }
    
    // Создаем контейнер для input
    const inputContainer = document.createElement('div');
    inputContainer.className = 'inline-input-container';
    inputContainer.appendChild(inputElement);
    
    // Очищаем ячейку и добавляем input
    cell.innerHTML = '';
    cell.appendChild(inputContainer);
    
    // Фокус на поле ввода
    inputElement.focus();
    
    // Обработка нажатия Enter и Escape
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            saveCell(cell);
        } else if (e.key === 'Escape') {
            cancelEditing(cell);
        }
    });
    
    // Сохранение при потере фокуса
    inputElement.addEventListener('blur', function() {
        setTimeout(() => {
            if (!cell.contains(document.activeElement)) {
                saveCell(cell);
            }
        }, 100);
    });
}

function startEditStatus(statusBadge) {
    const cell = statusBadge.closest('.editable-cell');
    startEditing(cell);
}

function saveCell(cell) {
    // Если cell - это кнопка, находим родительскую ячейку
    if (cell.tagName === 'BUTTON') {
        cell = cell.parentElement;
    }
    
    const inputElement = cell.querySelector('input, select, textarea');
    if (!inputElement) return;
    
    const newValue = inputElement.value;
    const field = cell.getAttribute('data-field');
    const orderId = cell.closest('tr').getAttribute('data-order-id');
    const type = cell.getAttribute('data-type') || 'text';
    
    // Валидация
    if (field === 'quantity' && (!newValue || parseInt(newValue) < 1)) {
        showNotification('Количество мест должно быть не менее 1', 'error');
        return;
    }
    
    if ((field === 'weight' || field === 'volume') && parseFloat(newValue) < 0) {
        showNotification('Значение должно быть положительным', 'error');
        return;
    }
    
    // Для адресов: проверка на пустоту
    if ((field === 'pickup_address' || field === 'delivery_address') && newValue.trim() === '') {
        showNotification('Адрес не может быть пустым', 'error');
        return;
    }
    
    // Отправка на сервер
    saveToServer(orderId, field, newValue, cell, type);
}

function saveToServer(orderId, field, value, cell, type) {
    const url = `{% url 'delivery_order_update_field' 0 %}`.replace('0', orderId);
    const csrfToken = getCookie('csrftoken');
    
    // Показываем индикатор загрузки
    cell.classList.add('loading');
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            field: field,
            value: value
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        cell.classList.remove('loading');
        
        if (data.success) {
            updateCellDisplay(cell, field, value, data.display_value, type);
            showNotification('Изменения сохранены', 'success');
            editingCell = null;
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
            cancelEditing(cell);
        }
    })
    .catch(error => {
        cell.classList.remove('loading');
        console.error('Error:', error);
        showNotification('Ошибка сети при сохранении: ' + error.message, 'error');
        cancelEditing(cell);
    });
}

function updateCellDisplay(cell, field, value, displayValue, type) {
    cell.classList.remove('editing');
    
    if (field === 'status') {
        // Обновляем badge статуса
        const statusClass = `status-${value}`;
        
        cell.innerHTML = `
            <span class="status-badge-editable ${statusClass}" onclick="startEditStatus(this)">
                ${displayValue || value}
            </span>
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'date') {
        // Форматируем дату для отображения
        let displayText = '-';
        if (value) {
            const date = new Date(value);
            if (!isNaN(date)) {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                displayText = `${day}.${month}.${year}`;
            }
        }
        cell.innerHTML = `
            ${displayText}
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'pickup_address' || field === 'delivery_address') {
        // Для адресов используем специальную структуру с подсказкой
        let addressText = value || '';
        let displayText = addressText;
        let titleText = addressText;
        
        if (!addressText || addressText.trim() === '') {
            displayText = "Не указан";
            titleText = "Не указан";
        } else if (addressText.length > 30) {
            displayText = addressText.substring(0, 30) + '...';
            titleText = addressText;
        }
        
        cell.innerHTML = `
            <div class="address-text" title="${titleText}">${displayText}</div>
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', addressText);
    } else if (field === 'driver_name') {
        // Для имени водителя
        if (!value || value.trim() === '') {
            cell.innerHTML = `
                <span class="text-muted">Не назначен</span>
                <button class="save-btn" onclick="saveCell(this)">✓</button>
                <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
            `;
        } else {
            cell.innerHTML = `
                ${value}
                <button class="save-btn" onclick="saveCell(this)">✓</button>
                <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
            `;
        }
        cell.setAttribute('data-original', value);
    } else if (field === 'driver_phone') {
        // Для телефона водителя
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'weight' || field === 'volume') {
        // Для веса и объема
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    } else if (field === 'quantity') {
        // Для количества мест
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    } else {
        // Для всех остальных полей
        cell.innerHTML = `
            ${value}
            <button class="save-btn" onclick="saveCell(this)">✓</button>
            <button class="cancel-btn" onclick="cancelEditing(this.parentElement)">✗</button>
        `;
        cell.setAttribute('data-original', value);
    }
}

function cancelEditing(cell) {
    const originalContent = cell.getAttribute('data-original-content');
    if (originalContent) {
        cell.innerHTML = originalContent;
    }
    cell.classList.remove('editing');
    editingCell = null;
}

function showNotification(message, type) {
    // Удаляем старые уведомления
    const oldNotifications = document.querySelectorAll('.notification-alert');
    oldNotifications.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
    });
    
    // Создаем новое уведомление
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show notification-alert`;
    alert.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            ${type === 'success' ? 
                '<i class="bi bi-check-circle-fill me-2 fs-5"></i>' : 
                '<i class="bi bi-exclamation-circle-fill me-2 fs-5"></i>'
            }
            <div>${message}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Вставляем в body
    document.body.appendChild(alert);
    
    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        if (alert.parentNode) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}

// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== ИНИЦИАЛИЗАЦИЯ МАССОВЫХ ДЕЙСТВИЙ ====================

function initBulkActions() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportListPdfBtn = document.getElementById('exportListPdfBtn');
    const selectedCount = document.getElementById('selectedCount');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    const bulkActionsForm = document.getElementById('bulkActionsForm');
    const listPdfForm = document.getElementById('listPdfForm');
    
    if (!selectAllCheckbox) return;
    
    function updateSelectedCount() {
        const selected = document.querySelectorAll('.order-checkbox:checked');
        if (selectedCount) {
            selectedCount.textContent = `Выбрано: ${selected.length}`;
        }
        if (exportPdfBtn) {
            exportPdfBtn.disabled = selected.length === 0;
        }
        if (exportListPdfBtn) {
            exportListPdfBtn.disabled = selected.length === 0;
        }
        updateBulkEditButton();
    }
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            orderCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedCount();
        });
    }
    
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            orderCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = true;
            updateSelectedCount();
        });
    }
    
    if (deselectAllBtn) {
        deselectAllBtn.addEventListener('click', function() {
            orderCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectedCount();
        });
    }
    
    orderCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCount();
        });
    });
    
    if (bulkActionsForm) {
        bulkActionsForm.addEventListener('submit', function(e) {
            const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                e.preventDefault();
                alert('Пожалуйста, выберите хотя бы одну заявку');
                return;
            }
            
            const oldInputs = this.querySelectorAll('input[name="order_ids"]');
            oldInputs.forEach(input => input.remove());
            
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'order_ids';
                hiddenInput.value = checkbox.value;
                this.appendChild(hiddenInput);
            });
        });
    }
    
    // Обработчик для кнопки "Список в PDF"
    if (exportListPdfBtn && listPdfForm) {
        exportListPdfBtn.addEventListener('click', function() {
            const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                alert('Пожалуйста, выберите хотя бы одну заявку');
                return;
            }
            
            // Очищаем старые поля
            const oldInputs = listPdfForm.querySelectorAll('input[name="order_ids"]');
            oldInputs.forEach(input => input.remove());
            
            // Добавляем новые поля с выбранными заявками
            selectedCheckboxes.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'order_ids';
                hiddenInput.value = checkbox.value;
                listPdfForm.appendChild(hiddenInput);
            });
            
            // Отправляем форму
            listPdfForm.submit();
        });
    }
    
    updateSelectedCount();
    initBulkEditing();
}

// ==================== МАССОВОЕ РЕДАКТИРОВАНИЕ ====================

function updateBulkEditButton() {
    const bulkEditBtn = document.getElementById('bulkEditBtn');
    if (!bulkEditBtn) return;
    
    const selected = document.querySelectorAll('.order-checkbox:checked');
    bulkEditBtn.disabled = selected.length === 0;
}

function initBulkEditing() {
    const bulkEditBtn = document.getElementById('bulkEditBtn');
    if (!bulkEditBtn) return;
    
    bulkEditBtn.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        if (selectedCheckboxes.length === 0) {
            alert('Пожалуйста, выберите заявки для редактирования');
            return;
        }
        
        // Обновляем счетчик выбранных заявок (с проверкой на существование элемента)
        const selectedOrdersCountEl = document.getElementById('selectedOrdersCount');
        if (selectedOrdersCountEl) {
            selectedOrdersCountEl.textContent = selectedCheckboxes.length;
        }
        
        // Сбрасываем форму
        const bulkEditField = document.getElementById('bulkEditField');
        const bulkEditValueContainer = document.getElementById('bulkEditValueContainer');
        
        if (bulkEditField) bulkEditField.value = '';
        if (bulkEditValueContainer) bulkEditValueContainer.innerHTML = '';
        
        // Показываем модальное окно
        const bulkEditModalEl = document.getElementById('bulkEditModal');
        if (bulkEditModalEl) {
            bulkEditModal = new bootstrap.Modal(bulkEditModalEl);
            bulkEditModal.show();
        } else {
            console.error('Модальное окно массового редактирования не найдено');
        }
    });
    
    // Обработчик изменения поля
    const bulkEditFieldEl = document.getElementById('bulkEditField');
    if (bulkEditFieldEl) {
        bulkEditFieldEl.addEventListener('change', function() {
            const field = this.value;
            const container = document.getElementById('bulkEditValueContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!field) return;
            
            let inputHtml = '';
            
            switch(field) {
                case 'status':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Новый статус</label>
                        <select class="form-select" id="bulkEditValue">
                            <option value="">Выберите статус</option>
                            <option value="submitted">Подана</option>
                            <option value="driver_assigned">Водитель назначен</option>
                            <option value="shipped">Отправлено</option>
                        </select>
                    `;
                    break;
                    
                case 'driver_name':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Имя водителя</label>
                        <input type="text" class="form-control" id="bulkEditValue" placeholder="Введите ФИО водителя">
                    `;
                    break;
                    
                case 'driver_phone':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Телефон водителя</label>
                        <input type="text" class="form-control" id="bulkEditValue" placeholder="+7 (XXX) XXX-XX-XX">
                    `;
                    break;
                    
                case 'vehicle':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Транспортное средство</label>
                        <input type="text" class="form-control" id="bulkEditValue" placeholder="Марка и номер ТС">
                    `;
                    break;
                    
                case 'date':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Дата доставки</label>
                        <input type="date" class="form-control" id="bulkEditValue">
                    `;
                    break;
                    
                case 'fulfillment':
                    // Загружаем операторов для выбора
                    loadFulfillmentOperatorsForBulk();
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Фулфилмент оператор</label>
                        <select class="form-select" id="bulkEditValue">
                            <option value="">Загрузка операторов...</option>
                        </select>
                    `;
                    break;
                    
                case 'quantity':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Количество мест</label>
                        <input type="number" class="form-control" id="bulkEditValue" min="1" placeholder="Введите число">
                    `;
                    break;
                    
                case 'weight':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Вес (кг)</label>
                        <input type="number" class="form-control" id="bulkEditValue" min="0" step="0.01" placeholder="Введите вес">
                    `;
                    break;
                    
                case 'volume':
                    inputHtml = `
                        <label for="bulkEditValue" class="form-label">Объем (м³)</label>
                        <input type="number" class="form-control" id="bulkEditValue" min="0" step="0.01" placeholder="Введите объем">
                    `;
                    break;
            }
            
            container.innerHTML = inputHtml;
        });
    }
    
    // Кнопка сохранения изменений
    const bulkEditSaveBtn = document.getElementById('bulkEditSaveBtn');
    if (bulkEditSaveBtn) {
        bulkEditSaveBtn.addEventListener('click', saveBulkChanges);
    }
}

// Загрузка операторов фулфилмента для выпадающего списка
function loadFulfillmentOperatorsForBulk() {
    const csrfToken = getCookie('csrftoken');
    
    fetch('{% url "get_operators" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        const select = document.getElementById('bulkEditValue');
        if (select) {
            select.innerHTML = '<option value="">Выберите оператора</option>';
            data.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator.id;
                option.textContent = operator.full_name || operator.username;
                select.appendChild(option);
            });
        }
    })
    .catch(error => {
        console.error('Ошибка загрузки операторов:', error);
        const select = document.getElementById('bulkEditValue');
        if (select) {
            select.innerHTML = '<option value="">Ошибка загрузки</option>';
        }
    });
}

// Сохранение массовых изменений
function saveBulkChanges() {
    const field = document.getElementById('bulkEditField');
    const valueInput = document.getElementById('bulkEditValue');
    
    if (!field || !valueInput) {
        showNotification('Ошибка: элементы формы не найдены', 'error');
        return;
    }
    
    const fieldValue = field.value;
    const value = valueInput.value;
    
    if (!fieldValue) {
        showNotification('Выберите поле для редактирования', 'error');
        return;
    }
    
    if (value === '') {
        showNotification('Введите значение для поля', 'error');
        return;
    }
    
    // Собираем ID выбранных заявок
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (orderIds.length === 0) {
        showNotification('Не выбраны заявки для редактирования', 'error');
        return;
    }
    
    // Показываем индикатор загрузки
    const saveBtn = document.getElementById('bulkEditSaveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...';
    saveBtn.disabled = true;
    
    // Отправка запроса на сервер
    const csrfToken = getCookie('csrftoken');
    const url = '{% url "delivery_orders_bulk_update" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            order_ids: orderIds,
            field: fieldValue,
            value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        if (data.success) {
            showNotification(`Успешно обновлено ${data.updated_count} из ${data.total_count} заявок`, 'success');
            
            // Закрываем модальное окно
            if (bulkEditModal) {
                bulkEditModal.hide();
            }
            
            // Обновляем страницу через 1.5 секунды, чтобы увидеть изменения
            setTimeout(() => {
                location.reload();
            }, 1500);
            
        } else {
            showNotification('Ошибка: ' + data.error, 'error');
        }
    })
    .catch(error => {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        console.error('Ошибка при массовом обновлении:', error);
        showNotification('Ошибка сети: ' + error.message, 'error');
    });
}

// ==================== СОРТИРОВКА ТАБЛИЦЫ ====================

document.addEventListener('DOMContentLoaded', function() {
    const sortableHeaders = document.querySelectorAll('.sortable-header');
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortField = this.getAttribute('data-sort');
            const currentUrl = new URL(window.location.href);
            const currentSort = currentUrl.searchParams.get('sort') || 'date';
            const currentOrder = currentUrl.searchParams.get('order') || 'desc';
            
            let newOrder = 'asc';
            
            if (currentSort === sortField) {
                // Меняем направление сортировки
                newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            }
            
            // Устанавливаем параметры сортировки
            currentUrl.searchParams.set('sort', sortField);
            currentUrl.searchParams.set('order', newOrder);
            
            // Переходим на обновленный URL
            window.location.href = currentUrl.toString();
        });
    });
    
    // Проверка прав доступа для редактирования
    const canEdit = !{{ is_operator|yesno:"true,false" }};
    
    if (!canEdit) {
        // Для операторов отключаем все возможности редактирования
        const editableCells = document.querySelectorAll('.editable-cell');
        editableCells.forEach(cell => {
            cell.style.cursor = 'default';
            cell.style.transition = 'none';
            
            cell.onclick = null;
            cell.ondblclick = null;
            cell.onmouseenter = null;
            cell.onmouseleave = null;
            
            cell.classList.remove('editable-cell');
            
            const saveBtn = cell.querySelector('.save-btn');
            const cancelBtn = cell.querySelector('.cancel-btn');
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        });
        
        const statusBadges = document.querySelectorAll('.status-badge-editable');
        statusBadges.forEach(badge => {
            badge.style.cursor = 'default';
            badge.onclick = null;
            badge.style.pointerEvents = 'none';
        });
    }
});

// Глобальные функции для использования в onclick
window.saveCell = saveCell;
window.cancelEditing = cancelEditing;
window.startEditStatus = startEditStatus;
window.openAddressModal = openAddressModal;
</script>

{% if is_operator %}
</div>
{% endif %}
{% endblock %}